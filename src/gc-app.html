<!-- Polymer elements -->
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/iron-localstorage/iron-localstorage.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner-lite.html">
<!-- Community elements-->
<link rel="import" href="../bower_components/parallax-container/parallax-container.html">
<link rel="import" href="vimeo-player.html">
<link rel="import" href="image-slider.html">
<!-- Project elements-->
<link rel="import" href="gc-icons.html">
<link rel="import" href="gc-styles.html">

<dom-module id="gc-app">
  <template>
    <style include="gc-styles">
      :host {
        --app-primary-color: white;
        --app-secondary-color: black;
        display: block;
        padding: 0px;
        overflow: hidden;
        iron-image {
          --iron-image-width: 100%;
        }
      }

      .video-of-the-month {
        width: 90%;
      }

      .event-video {
        width: 100%;
      }
    </style>

    <!-- Language settings local storage -->
    <iron-localstorage
      name="gamechangers-storage"
      value="{{storage}}"
      on-iron-localstorage-load-empty="initializeDefaultStorage"
      on-iron-localstorage-load="handleLocalstorageLoadEvent"
    ></iron-localstorage>

    <!-- app route. Query params used for deep linking -->
    <app-location route="{{route}}" query-params="{{queryParams}}"></app-location>

    <!-- Load video of the month vimeo ID -->
    <iron-ajax
      id="requestVideoOfTheMonth"
      url="https://deepamehta.aalto.fi/gamechangers/v1/featured_video"
      handle-as="json"
      on-response="handleResponseVideoOfTheMonth">
    </iron-ajax>

<!--    <parallax-container> -->

    <!-- Alpha message section above timeline -->
    <template is="dom-if" if="{{storageLoaded}}">

      <!-- Language change and credits buttons -->
      <div class="menuButtons">
        <paper-button on-tap="changeLanguage">{{storage.label}}</paper-button>
        <paper-button on-tap="openCreditsDialog">Credits</paper-button>
        <paper-dialog id="creditsDialog">
           <p>Credits and photo credits here</p>
        </paper-dialog>
      </div>

      <div class="container flex-horizontal">
        <div style="position: relative; left: 0; top: 0; min-width: 120px;">
          <!-- <img src="/pictures/futureDates.png" style="position: relative; top: 0; left: 0; margin: 50px 70px 30px 26px;"/> -->
          <img src="/pictures/alpha.png" style="position: absolute; top: 0px; left: 0px;"/>
        </div>
        <div class="flexchild">
          <img src="/pictures/{{localisedTitle()}}" style="position: relative; top: 20px; left: 0; margin: 60px 0px 60px 0px;"/>
            <div class="container flex-horizontal">
              <div class="flexchild">
                <h1 class="info">{{localisedH1()}}</h1>
                <p class="info">{{localisedP1()}}</p>
                </br>
                <p class="info">{{localisedP2()}}</p>
                </br>
                <!-- <paper-button on-tap="handleEventPropose" style="background-color: #F8E81C; border-radius: 0; margin: 0;">{{localisedPropose()}}</paper-button> -->
                <paper-dialog class="input-dialog" id="proposeDialog" modal>
                   <p>{{localisedProposeDescription()}}</p>
                   <form is="iron-form" id="propose" method="post" content-type="application/json" action="{{getProposeURL}}" on-iron-form-response="handleResponsePropose">
                         <paper-input name="name" label="{{localisedName()}}" char-counter maxlength="160" auto-validate error-message="Please enter your name"></paper-input>
                         <paper-input name="email" label="{{localisedEmail()}}" char-counter maxlength="160" auto-validate error-message="Please enter your email"></paper-input>
                         <paper-input name="notes" label="{{localisedPropose()}}" char-counter maxlength="160" auto-validate error-message="Please enter your proposal"></paper-input>
                         <br>
                         <paper-button dialog-dismiss>{{localisedCancel()}}</paper-button>
                         <paper-button raised autofocus on-tap="submitProposal">{{localisedSubmit()}}</paper-button>
                   </form>
                </paper-dialog>
                </br>
                </br>
                <h1 class="info">{{localisedVideoH1()}}</h1>
                <div class="video-of-the-month">
                  <vimeo-player id="videoOfTheMonth" videoid="{{videoOfTheMonth}}"></vimeo-player>
                </div>
                <p class="info"> </p>
                <p class="info"> </p>
                </br>
              </div>
              <div class="flexchild">
                </br>
              </div>
            </div>
        </div>
      </div>
    </template>

    <!-- Spinner - hidden after data has loaded -->
    <paper-spinner-lite active id="spinner" alt="Loading timeline"></paper-spinner-lite>

    <!-- Timeline template -->
    <div id="timeline" on-dom-change="eraDOM">
    <template  is="dom-repeat" items="{{eras}}" sort="sortEras" >

      <div class="era" style="background:url([[item.images.0.url]]) no-repeat;">
        <p class="eraName"> {{item.name}} </p>

        <!-- Events template -->
        <template is="dom-repeat" items="{{item.events}}" sort="sortEvents" as="eventItem">

          <div class$="[[eventItem.type]]" id$="eventDiv[[eventItem.id]]">
           <div class="container flex-horizontal">

            <!-- Column 1 - the year/decade -->
            <div class="year">
              <template is="dom-if" if="{{yearIsFirstInDecade(eventItem.from)}}">
                <div style="font-weight: bold;">{{eventYear(eventItem.from)}}</div>
              </template>
              <template is="dom-if" if="{{!yearIsFirstInDecade(eventItem.from)}}">
                {{eventYear(eventItem.from)}}
              </template>
            </div>

            <!-- Column 2 - comments -->
            <div class="flexchild">
              <div class="commentColumn">
                <div class="comment" id$="comment{{eventItem.id}}" style="display: none;">
                  <div class="flexchild">

                     <div class="comment-container">

                        <div class="comment-icon">
                          <iron-icon icon="comment"></iron-icon>
                        </div>

                        <div class="comment-text">
                          <template is="dom-repeat" items="{{eventItem.latestPublicComments}}" as="comment">
                            <p>{{comment.notes}}</p>
                            <p style="font-size: 11px;">{{comment.name}}</p>
                          </template>
                        </div>

                    </div>

                  </div>
                  <div class="leftArrow">
                    <img src="/pictures/arrowLeft.png" style="position: relative; top: 0; left: 0; margin: 12px;"/>
                  </div>
                </div>
              </div>
            </div>

            <!-- Column 3 - events -->
            <div class="flexchild">
              <paper-card>
                <div class="event" id="event">
                  <div class="event-header" style$="background-color: [[eventColour(eventItem.type)]];">
                    <paper-button on-tap="handleEventCollapse" style="max-width: 330px; font-family: 'Roboto Condensed', sans-serif; font-weight: bold; text-transform: none;">
                      <iron-icon src="/icns/{{eventItem.type}}.svg" style="margin-right: 8px;"></iron-icon>
                      <span class="buttontext">{{eventItem.name}}</span>
                    </paper-button>
                  </div>
                  <iron-collapse id$="collapse{{eventItem.id}}" style$="width:100%;">
                      <!-- Image div need to be conditional on images being present. also add icon button to go full screen -->
                      <template is="dom-if" if="{{!arrayEmpty(eventItem.images)}}">
                        <div class="event-image">
                          <iron-image style="width: 100%; height: 240px;" sizing="cover" src="[[eventItem.images.0.url]]"></iron-image>
                          <!-- ADD definitiion of Modal to show all images here and icon button to show the modal -->

                          <paper-icon-button id="fullscreen-button" src="/icns/fullscreen.svg" on-tap="handleEventCarousel"></paper-icon-button>

                          <paper-dialog id="carouselDialog[[eventItem.id]]" class="carousel-dialog" modal>
                            <image-slider images="{{formatImageArray(eventItem.images)}}" captions="{{formatCaptionArray(eventItem.images)}}"></image-slider>
                            <!-- <div class="buttons"> -->
                              <paper-icon-button class="closeButton" src="/icns/close.svg" dialog-confirm autofocus></paper-icon-button>
                            <!-- </div> -->
                          </paper-dialog>

                        </div>
                      </template>

                      <!-- Vimeo player embed test -->
                      <template is="dom-if" if="{{eventItem.vimeoVideoId}}">
                        <div class="event-video">
                          <vimeo-player id="video{{eventItem.vimeoVideoId}}" videoid="{{eventItem.vimeoVideoId}}"></vimeo-player>
                        </div>
                      </template>

                      <div class="event-text">
                         <!-- <div inner-h-t-m-l="{{justText(eventItem.notes)}}"> </div> -->
                         <p style="white-space: pre-line;">{{eventItem.notes}}
                         </p>
                      </div>
                      <div class="event-footer">
                           <paper-button on-tap="handleEventComment">Comment</paper-button>

                          <!-- <paper-button raised onclick="modal{{eventItem.id}}.open()">Comment</paper-button> -->
                          <paper-dialog class="input-dialog" id="commentDialog[[eventItem.id]]" modal>
                            <p>{{localisedCommentDescription()}}</p>
                            <form is="iron-form" id="form[[eventItem.id]]" method="post" content-type="application/json" action="{{getCommentURL}}" on-iron-form-response="handleResponseComment">
                                  <paper-input name="name" label="{{localisedName()}}" char-counter maxlength="160" auto-validate error-message="Please enter your name"></paper-input>
                                  <paper-input name="email" label="{{localisedEmail()}}" char-counter maxlength="160" auto-validate error-message="Please enter your email"></paper-input>
                                  <paper-input name="notes" label="{{localisedComment()}}" char-counter maxlength="160" auto-validate error-message="Please enter a comment"></paper-input>
                                  <input type="hidden" name="commentedItemId" value="[[eventItem.id]]"/>
                                  <br>
                                  <paper-button dialog-dismiss>{{localisedCancel()}}</paper-button>
                                  <paper-button raised autofocus on-tap="submitComment">{{localisedSubmit()}}</paper-button>
                            </form>
                            <div class="buttons">

                            </div>
                          </paper-dialog>

                      </div>
                  </iron-collapse>
                </div>
              </paper-card>
            </div>

            <!-- Column 4 - associations -->
            <div class="flexchild">
              <div class="associationColumn">
                <div class="associations" id$="associations{{eventItem.id}}" style="display: none;">
                  <div class="rightArrow">
                    <img src="/pictures/arrowRight.png" style="position: relative; top: 0; left: 0; margin: 12px;"/>
                  </div>
                  <div class="flexchild">
                    <template is="dom-repeat" items="{{eventItem.associatedItems}}" as="association">
                      <paper-card>
                        <div class="association">
                          <div class="association-header" style$="background-color: {{eventColour(association.type)}};">
                            <paper-button id$="{{association.id}}" on-tap="handleAssociationCollapse" style="max-width: 330px; font-family: 'Roboto Condensed', sans-serif; font-weight: bold; text-transform: none;">
                              <!-- <iron-icon icon={{eventItem.type}} style="margin-right: 8px;"></iron-icon> -->
                              <iron-icon src="/icns/{{association.type}}.svg" style="margin-right: 8px;"></iron-icon>
                              <span class="buttontext">{{association.name}}</span>
                            </paper-button>
                          </div>
                          <iron-collapse id$="associationCollapse{{eventItem.id}}{{association.id}}" style="width:100%;">

                              <template is="dom-if" if="{{!arrayEmpty(association.images)}}">
                                <div class="association-image">
                                  <iron-image style="width: 100%; height: 240px" sizing="cover" src="{{association.images.0.url}}"></iron-image>

                                </div>
                              </template>

                              <!-- Vimeo player embed test -->
                              <template is="dom-if" if="{{association.vimeoVideoId}}">
                                <div class="event-video">
                                  <vimeo-player id="video{{association.vimeoVideoId}}" videoid="{{association.vimeoVideoId}}"></vimeo-player>
                                </div>
                              </template>

                              <div class="association-title">
                                  <p>{{association.name}} ({{{{eventYear(association.from)}}}})</p>
                              </div>
                              <div class="association-text">
                                 <!-- <div inner-h-t-m-l="{{justText(association.notes)}}"></div> -->
                                 <p>{{association.notes}}</p>
                              </div>
                          </iron-collapse>

                        </div>
                      </paper-card>
                    </template>
                  </div>
                </div>
              </div>
            </div>

           </div>
          </div>

          </template>

        </div>

    </template>
  </div>

</br>
</br>
</br>
</br>

    <!-- Persistant toast bar used for filter buttons (Maybe add hide/collapsable area for buttons in the toast) -->
    <paper-toast id="toastFilters" duration="0" text="">
      <paper-icon-button id="filter_button_1_1" src="/icns/_1_1_admin.svg" on-tap="handleFilter" data-args="1_1"></paper-icon-button>
      <paper-icon-button id="filter_button_1_2" src="/icns/_1_2_campus.svg" on-tap="handleFilter" data-args="1_2"></paper-icon-button>
      <paper-icon-button id="filter_button_1_3" src="/icns/_1_3_students.svg" on-tap="handleFilter" data-args="1_3"></paper-icon-button>
      <paper-icon-button id="filter_button_1_4" src="/icns/_1_4_teaching.svg" on-tap="handleFilter" data-args="1_4"></paper-icon-button>
      <paper-icon-button id="filter_button_2_1" src="/icns/_2_1_art_and_design.svg" on-tap="handleFilter" data-args="2_1"></paper-icon-button>
      <paper-icon-button id="filter_button_2_2" src="/icns/_2_2_science_and_technology.svg" on-tap="handleFilter" data-args="2_2"></paper-icon-button>
      <paper-icon-button id="filter_button_2_3" src="/icns/_2_3_business.svg" on-tap="handleFilter" data-args="2_3"></paper-icon-button>
      <paper-icon-button id="filter_button_2_4" src="/icns/_2_4_research.svg" on-tap="handleFilter" data-args="2_4"></paper-icon-button>
      <paper-icon-button id="filter_button_2_5" src="/icns/_2_5_multidisciplinarity.svg" on-tap="handleFilter" data-args="2_5"></paper-icon-button>
      <paper-icon-button id="filter_button_3_1" src="/icns/_3_1_entrepreneurship.svg" on-tap="handleFilter" data-args="3_1"></paper-icon-button>
      <paper-icon-button id="filter_button_3_2" src="/icns/_3_2_corporate_collaboration.svg" on-tap="handleFilter" data-args="3_2"></paper-icon-button>
      <paper-icon-button id="filter_button_3_3" src="/icns/_3_3_academic_collaboration.svg" on-tap="handleFilter" data-args="3_3"></paper-icon-button>
      <paper-icon-button id="filter_button_4_1" src="/icns/_4_1_global_event.svg" on-tap="handleFilter" data-args="4_1"></paper-icon-button>
      <paper-icon-button id="filter_button_4_2" src="/icns/_4_2_regional_event.svg" on-tap="handleFilter" data-args="4_2"></paper-icon-button>
    </paper-toast>

    <!--    </parallax-container> -->

    <!-- Initial call to get Era data -->
    <iron-ajax
      id="requestEras"
      url=""
      handle-as="json"
      on-response="handleResponseEras">
    </iron-ajax>

  </template>

  <script>
    Polymer({
      is: 'gc-app',

      properties: {
        /**
        * Domain for API calls.
        * @attribute domain
        * @type string
        * @default https://deepamehta.aalto.fi
        */
        domain: {
          type: String,
          //value: 'http://localhost:8080'
          value: 'https://deepamehta.aalto.fi'
        },
        /**
        * Language setting fi=finnish en=english NB USE LOCAL STORAGE INSTEAD
        * @attribute language
        * @type sting
        * @default fi
        */
        language: {
          type: String,
          value: 'fi'
        },
        /**
        * Local storage
        * @attribute storage
        * @type object
        */
        storage: {
          type: Object
        },
        /**
        * API version string. v1, v2, etc.
        * @attribute version
        * @type sting
        * @default v2
        */
        version: {
          type: String,
          value: 'v2'
        },
        storageLoaded: {
          type: Boolean,
          value: false
        },
        itemCount: {
          type: Number,
          value: 0
        },
        filter1_1: {
          type: Boolean,
          value: true
        },
        filter1_2: {
          type: Boolean,
          value: true
        },
        filter1_3: {
          type: Boolean,
          value: true
        },
        filter1_4: {
          type: Boolean,
          value: true
        },
        filter2_1: {
          type: Boolean,
          value: true
        },
        filter2_2: {
          type: Boolean,
          value: true
        },
        filter2_3: {
          type: Boolean,
          value: true
        },
        filter2_4: {
          type: Boolean,
          value: true
        },
        filter2_5: {
          type: Boolean,
          value: true
        },
        filter3_1: {
          type: Boolean,
          value: true
        },
        filter3_2: {
          type: Boolean,
          value: true
        },
        filter3_3: {
          type: Boolean,
          value: true
        },
        filter4_1: {
          type: Boolean,
          value: true
        },
        filter4_2: {
          type: Boolean,
          value: true
        }
      },
      // When ready call API to get video of the month Id
      ready: function(){
        this.$.requestVideoOfTheMonth.generateRequest();
      },
      // Initialise local strage with default lang (fi)
      initializeDefaultStorage: function() {
        //console.log("storage Init")
        this.storage = {
          lang: "fi",
          label: "English"
        }
        // Trigger load data manually after init on first visit
        this.handleLocalstorageLoadEvent();
      },
      // Once we have local settings we know the language, so load data
      handleLocalstorageLoadEvent: function(){
        //console.log("local storage : @ storage load " + this.storage.lang);
        this.language = this.storage.lang;
        this.storageLoaded = true;
        // request Eras
        this.$.requestEras.url = this.domain + "/gamechangers/" + this.version + "/" + this.language + "/eras";
        this.$.requestEras.generateRequest();
      },
      // Toggle language between FI and EN then reload
      changeLanguage: function() {
        if (this.storage.lang == "fi") {
          this.set('storage.lang', "en");
          this.set('storage.label', "Suomeksi");
          this.language = "en";
        } else {
          this.set('storage.lang', "fi");
          this.set('storage.label', "English");
          this.language = "fi";
        }
        location.reload(false);
      },
      // Called everytime era dom is changed
      eraDOM: function(event) {
        // Once the dom changes have stopped, stop spinner, show toast, etc.
        this.debounce('doSomething', function () {
          //console.log('Debounce...');
          this.$.spinner.active = false;
          this.$.toastFilters.open();

          // open event if event id passed in route
          //console.log('this.queryParams', this.queryParams);
          //console.log('this.queryParams.event', this.queryParams.event);

          if (this.queryParams.event) {
            //console.log('Deep link...');
            var deep = "#eventDiv" + this.queryParams.event;
            this.$$(deep).scrollIntoView();
            var collapse = "#collapse" + this.queryParams.event;
            this.$$(collapse).toggle();
            var commentDiv = '#comment' + this.queryParams.event;
            var associationsDiv = '#associations' + this.queryParams.event;
            this.$$(commentDiv).style.display='flex'
            this.$$(associationsDiv).style.display='flex'
          }
        }, 300);
      },
      // UI Localisation functions
      localisedTitle: function() {
        return (this.language == "fi") ? "title_FIN.png" : "title.png";
      },
      localisedH1: function() {
        return (this.language == "fi") ? "Tervetuloa!" : "Welcome!";
      },
      localisedP1: function() {
        return (this.language == "fi") ? "Aalto-yliopiston aikajana kertoo visuaalisin keinoin tarinoita Muutoksentekijöistä – henkilöistä, tapahtumista tai innovaatioista – Aallon tai sen edeltäjien piirissä. Muutoksentekijöistä, joilla on ollut suuri vaikutus suomalaisen yhteiskunnan kehitykseen." : "This is a timeline of events from the history of Aalto University and its predecessor schools, that has had an impact for the Finnish society. Here are some historical milestones together with a few impactful chain of events, but this is just a start. Now  we reach out to the community. That is you. Share your insight.";
      },
      localisedP2: function() {
        return (this.language == "fi") ? "Aikajana kehittyy vähitellen, joten pyydämme myös sinun panostasi Aallon tarinaan alkaen vuodesta 1849. Kerro visiosi Aallon tulevaisuudesta. Jakaaksesi ajatuksesi liiku aikajanalla haluamaasi vuoteen ja ehdota lisättäväksi aihetta ja taustatietoja. Voit myös kirjoittaa kommenttikenttään anekdootteja jo kuvatuista aiheista. Odotamme panostasi, suurkiitos siitä etukäteen!" : "Scroll down the time and suggest a topic you think should be included. Please remember that the perspective here is “a game changer”, so we are looking for themes that have been enablers for disruptions. You can also suggest an anecdote directly regarding an event on the timeline. Thank you for your help.";
      },
      localisedVideoH1: function() {
        return (this.language == "fi") ? "Kuukauden video" : "Video of the month";
      },
      localisedPropose: function() {
        return (this.language == "fi") ? "Ehdota tapahtumaa" : "Suggest an event";
      },
      localisedComment: function() {
        return (this.language == "fi") ? "Kommentoi" : "Comment";
      },
      localisedShare: function() {
        return (this.language == "fi") ? "Jaa" : "Share";
      },
      localisedCommentDescription: function() {
        return (this.language == "fi") ? "Onko sinulla tähän tapahtumaan liittyvä anekdootti? Lähetä se ja sisältötiimimme julkaisee niistä osan. Käytä oikeaa nimeäsi ja toimivaa sähköpostiosoitetta niin voimme olla tarvittaessa yhteydessä sinuun." : "Do you have an anekdote relating to this event? Send it to us and our editorial team will publish some of them. Use your real name for signing it and working email we can reach you from should there be questions.";
      },
      localisedCommentSucceeded: function() {
        return (this.language == "fi") ? "Kiitos kommentistasi! Sisältötyöryhmä käy läpi kaikki kommentit ja julkaisee niistä osan. Otamme yhteyttä jos lisäkysymyksiä nousee esiin." : "Thank you for your comment. The editorial team will check all comments and publish some of them. We will contact you if further questions.";
      },
      localisedCommentFailed: function() {
        return (this.language == "fi") ? "Lähetys epäonnistui" : "Submit failed";
      },
      localisedProposeDescription: function() {
        return (this.language == "fi") ? "Puuttuko aikajanalta jotain? Lähetä ehdotus sisältötiimillemme. Olemme kiinnostuneita muutokseen johtaneista tapahtumista Aalto-yliopiston ja sitä edeltäneiden koulujen historiasta." : "Is something missing from the timeline? Send a suggestion for our editorial team. We are interested in game changer events from the history of Aalto University and it's predecessor schools.";
      },
      localisedProposeSucceeded: function() {
        return (this.language == "fi") ? "Kiitos ehdotuksestasi! Sisältötyöryhmä valitsee kaikista ehdotuksista muutoksentekijä tapahtumia. Otamme yhteyttä jos lisäkysymyksiä nousee esiin." : "Thank you for your suggestion. The editorial team will select new game changer events from all the suggestions. We will contact you if further questions.";
      },
      localisedProposeFailed: function() {
        return (this.language == "fi") ? "Lähetys epäonnistui" : "Submit failed";
      },
      localisedName: function() {
        return (this.language == "fi") ? "Nimi" : "Name";
      },
      localisedEmail: function() {
        return (this.language == "fi") ? "Email" : "Email";
      },
      localisedCancel: function() {
        return (this.language == "fi") ? "Peruuta" : "Cancel";
      },
      localisedSubmit: function() {
        return (this.language == "fi") ? "Lähetä" : "Submit";
      },

      // Function to check if an array is empty
      arrayEmpty: function(array) {
        return array.length == 0;
      },
      // Format the image array for image-slider, just urls, no captions
      formatImageArray: function(array) {
        var imageArray = [];
        for (var i = 0; i < array.length; i++) {
          imageArray[i] = array[i].url;
        }
        return imageArray;
      },
      // Format the captions array for image-slider, just captions, no urls
      formatCaptionArray: function(array) {
        var captionArray = [];
        for (var i = 0; i < array.length; i++) {
          captionArray[i] = array[i].caption;
        }
        return captionArray;
      },
      // Strip HTML tags, specifically img tags from notes
      justText: function(htmlContent) {
        // more efficient to do this in the backend?
        var r = htmlContent.replace(/<img[^>]*>/g,"");
        return r;
      },
      stripURL: function(url){
        //console.log ("striping : " + url);
        url = url.replace(/%2F/gi, "/");
        //console.log ("stripped : " + url);
        return url;
      },
      getCommentURL: function() {
        //return "http://localhost:8080/gamechangers/v1/comment";
        return this.domain + "/gamechangers/v1/comment";
      },
      getProposeURL: function() {
        //return "http://localhost:8080/gamechangers/v1/propose";
        return this.domain + "/gamechangers/v1/proposal";
      },
      // Handles data being returned from the API call to get video of the month
      handleResponseVideoOfTheMonth: function (data) {
          //console.log("Video of the month vime ID = " + data.detail.response);
          this.videoOfTheMonth = data.detail.response;
      },
      // Handles data being returned from the API call to get eras
      handleResponseEras: function (data) {
          //console.log("number of eras = " + data.detail.response.length);
          this.eras = data.detail.response;
      },
      // Event sorting function
      sortEvents: function (a, b) {
          return parseFloat(b.from) - parseFloat(a.from);
      },
      // Era sorting function
      sortEras: function (a, b) {
          return parseFloat(b.from) - parseFloat(a.from);
      },
      // Toggle event cards visibility based on event types
      handleFilter: function(e) {
        var filter = "--display" + e.target.dataset.args;
        var selector = "#filter_button_" + e.target.dataset.args;
        var d;
        var op;
        switch (e.target.dataset.args) {
          case "1_1":
              d = this.filter1_1 ? "none" : "inline";
              op = this.filter1_1 ? "0.5" : "1.0";
              this.filter1_1 = !this.filter1_1;
              break;
          case "1_2":
              d = this.filter1_2 ? "none" : "inline";
              op = this.filter1_2 ? "0.5" : "1.0";
              this.filter1_2 = !this.filter1_2;
              break;
          case "1_3":
              d = this.filter1_3 ? "none" : "inline";
              op = this.filter1_3 ? "0.5" : "1.0";
              this.filter1_3 = !this.filter1_3;
              break;
          case "1_4":
              d = this.filter1_4 ? "none" : "inline";
              op = this.filter1_4 ? "0.5" : "1.0";
              this.filter1_4 = !this.filter1_4;
              break;
          case "2_1":
              d = this.filter2_1 ? "none" : "inline";
              op = this.filter2_1 ? "0.5" : "1.0";
              this.filter2_1 = !this.filter2_1;
              break;
          case "2_2":
              d = this.filter2_2 ? "none" : "inline";
              op = this.filter2_2 ? "0.5" : "1.0";
              this.filter2_2 = !this.filter2_2;
              break;
          case "2_3":
              d = this.filter2_3 ? "none" : "inline";
              op = this.filter2_3 ? "0.5" : "1.0";
              this.filter2_3 = !this.filter2_3;
              break;
          case "2_4":
              d = this.filter2_4 ? "none" : "inline";
              op = this.filter2_4 ? "0.5" : "1.0";
              this.filter2_4 = !this.filter2_4;
              break;
          case "2_5":
              d = this.filter2_5 ? "none" : "inline";
              op = this.filter2_5 ? "0.5" : "1.0";
              this.filter2_5 = !this.filter2_5;
              break;
          case "3_1":
              d = this.filter3_1 ? "none" : "inline";
              op = this.filter3_1 ? "0.5" : "1.0";
              this.filter3_1 = !this.filter3_1;
              break;
          case "3_2":
              d = this.filter3_2 ? "none" : "inline";
              op = this.filter3_2 ? "0.5" : "1.0";
              this.filter3_2 = !this.filter3_2;
              break;
          case "3_3":
              d = this.filter3_3 ? "none" : "inline";
              op = this.filter3_3 ? "0.5" : "1.0";
              this.filter3_3 = !this.filter3_3;
              break;
          case "4_1":
              d = this.filter4_1 ? "none" : "inline";
              op = this.filter4_1 ? "0.5" : "1.0";
              this.filter4_1 = !this.filter4_1;
              break;
          case "4_2":
              d = this.filter4_2 ? "none" : "inline";
              op = this.filter4_2 ? "0.5" : "1.0";
              this.filter4_2 = !this.filter4_2;
              break;
        }
        //console.log("filter : " + filter + " equals " + d);
        //this.$$(commentDiv).style.src='none'

        //console.log("button equals " + selector + " and op equals " + op + " filter equals " + filter);
        this.$$(selector).style.opacity = op;
        this.customStyle[filter] = d;
        this.updateStyles();
      },
      // Toggle event card collapse on tap based on ID
      handleEventCollapse: function(event, detail, sender) {
        var id = event.model.eventItem.id;
        var selector = '#collapse' + id;
        var commentDiv = '#comment' + id;
        var associationsDiv = '#associations' + id;
        if (this.$$(selector).opened) {
          this.$$(commentDiv).style.display='none'
          this.$$(associationsDiv).style.display='none'
        } else {
          this.$$(commentDiv).style.display='flex'
          this.$$(associationsDiv).style.display='flex'
        }
        this.$$(selector).toggle();
      },
      // Toggle association card collapse on tap based on ID
      handleAssociationCollapse: function(event, detail, sender) {
        //console.log("association id" + event.model.association.id);
        var id = event.model.eventItem.id;
        var associationId = event.model.association.id;
        var card = '#associationCollapse' + id + associationId;
        this.$$(card).toggle();
      },
      handleEventComment: function(event, detail, sender) {
        //console.log("comment tap event");
        var id = event.model.eventItem.id;
        //console.log("open comment dialog for event : " + id);
        var dialog = '#commentDialog' + id;
        this.$$(dialog).open();
      },
      handleEventPropose: function(event, detail, sender) {
        this.$$("#proposeDialog").open();
      },
      openCreditsDialog: function() {
        this.$$("#creditsDialog").open();
      },
      // Open carousel dialog when full screen button is tapped
      handleEventCarousel: function(event, detail, sender) {
        //console.log("full screen tap event");
        var id = event.model.eventItem.id;
        //console.log("open image carousel dialog for event : " + id);
        var dialog = '#carouselDialog' + id;
        this.$$(dialog).open();
      },
      // Handle response from API after comment, display message close dialog on success.
      handleResponseComment: function (data) {
        var id = event.model.eventItem.id;
        //console.log("close comment dialog for event : " + id);
        //console.log("comment response : " + JSON.stringify(data.detail.response));
        //console.log("comment response id " + data.detail.response.id);

        var dialog = '#commentDialog' + id;
        this.$$(dialog).close();
        alert (this.localisedCommentSucceeded);
      },
      // Handle response from API after comment, display message close dialog on success.
      handleResponsePropose: function (data) {
        console.log("propose response : " + JSON.stringify(data.detail.response));
        console.log("propose response id " + data.detail.response.id);
        this.$$("#proposeDialog").close();
        alert (this.localisedProposeSucceeded);
      },
      // function used to submit comment form
      submitComment: function(event) {
        var form = event.target.parentElement;
        // work around to change method to PUT before submitting
        form.addEventListener('iron-form-presubmit', function() {
          //console.log("pre-submit form function called");
          this.request.method = 'PUT';
          this.request.url =  'https://deepamehta.aalto.fi/gamechangers/v1/comment';
          this.request.handleAs = 'json';
          //console.log(this.serialize());
        });
        form.addEventListener('iron-form-error', function(event) {
          //console.log("comment form error response");
          alert (this.localisedCommentFailed);
        });
        //console.log("submit form function called : ") ;
        form.submit();
      },
      // function used to submit comment form
      submitProposal: function(event) {
        var form = event.target.parentElement;
        // work around to change method to PUT before submitting
        form.addEventListener('iron-form-presubmit', function() {
          //console.log("pre-submit form function called");
          this.request.method = 'PUT';
          this.request.url =  'https://deepamehta.aalto.fi/gamechangers/v1/proposal';
          this.request.handleAs = 'json';
          //console.log(this.serialize());
        });
        form.addEventListener('iron-form-error', function(event) {
          //console.log("comment form error response");
          alert (this.localisedProposeFailed);
        });
        //console.log("submit form function called : ") ;
        form.submit();
      },
      // return the colour based on suplied event type
      eventColour: function (type) {
        var c;
        switch (type) {
          case "_1_1_admin":
              c = "#5677FC";
              break;
          case "_1_2_campus":
              c = "#5677FC";
              break;
          case "_1_3_students":
              c = "#5677FC";
              break;
          case "_1_4_teaching":
              c = "#5677FC";
              break;

          case "_2_1_art_and_design":
              c = "#EC407A";
              break;
          case "_2_2_science_and_technology":
              c = "#EC407A";
              break;
          case "_2_3_business":
              c = "#EC407A";
              break;
          case "_2_4_research":
              c = "#EC407A";
              break;
          case "_2_5_multidisciplinarity":
              c = "#EC407A";
              break;

          case "_3_1_entrepreneurship":
              c = "#FF9800";
              break;
          case "_3_2_corporate_collaboration":
              c = "#FF9800";
              break;
          case "_3_3_academic_collaboration":
              c = "#FF9800";
              break;

          case "_4_1_global_event":
              c = "#7ED321";
              break;
          case "_4_2_regional_event":
              c = "#7ED321";
              break;

          default:
              c = "#9B9B9B";
        }
        return c;
      },
      // return year string of timestamp supplied  *** change this to only return the first instance of each year
      // ie use global array to keep track of already returned years and not return those strings
      // Also need to use  var n = str.endsWith("0"); to check for decades, so decade can have larger font size.
      eventYear: function (timestamp) {
        var d = new Date(timestamp);
        return d.getFullYear();
      },
      // Return true if the year end in 0, i.e. first in a decade
      yearIsFirstInDecade: function (timestamp) {
        var d = new Date(timestamp);
        var y = d.getFullYear();
        var s = y.toString();
        var l = s.substr(s.length - 1);
        return l == "0";
      }
    });
  </script>

</dom-module>
