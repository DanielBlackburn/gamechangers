<!-- Polymer elements -->
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<!-- Community elements-->
<link rel="import" href="../bower_components/parallax-container/parallax-container.html">
<link rel="import" href="vimeo-player.html">
<link rel="import" href="image-slider.html">
<link rel="import" href="icon-toggle.html">
<!-- Project elements-->
<link rel="import" href="gc-icons.html">
<link rel="import" href="gc-styles.html">


<dom-module id="gc-app">
  <template>
    <style include="gc-styles">
      :host {
        --app-primary-color: white;
        --app-secondary-color: black;

        display: block;
        padding: 0px;
        overflow: hidden;

        --testcolour1: #00ff00;
        --display1_1: flex;
        --display1_2: flex;
        --display1_3: flex;
        --display1_4: flex;
        --display2_1: flex;
        --display2_2: flex;
        --display2_3: flex;
        --display2_4: flex;
        --display2_5: flex;
        --display3_1: flex;
        --display3_2: flex;
        --display3_3: flex;
        --display4_1: flex;
        --display4_1: flex;

        iron-image {
          --iron-image-width: 100%;
        }
      }
    </style>
    <style is="custom-style">
      paper-dialog.carousel-dialog {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        padding: 0;
        margin: 50px;
        overflow: hidden;
        background-color: #000;
      }

      .closeButton {
          position: absolute;
          top: 0;
          left: auto;
          right: 0;
          bottom: auto;
          background-color: var(--paper-grey-300);
          opacity: 0.75;
          color: var(--paper-grey-700);
          border-radius: 20px;
          margin: 10px;
          color: #fff;
      }

      .era {

      }

      .campus{
        display: var(--customdisplay, flex);

      }

      ._1_1_admin{
        display: var(--test1_1, flex);

      }

      ._1_2_campus{
        display: var(--test1_2, flex);
      }

      ._1_3_students{
        display: var(--test1_3, flex);
      }

      ._1_4_teaching{
        display: var(--test1_4, flex);
      }

      ._2_1_art_and_design{
        display: var(--display2_1);
      }

      ._2_2_science_and_technology{
        display: var(--display2_2);
      }

      ._2_3_business{
        display: var(--display2_3);
      }

      ._2_4_research{
        display: var(--display2_4);
      }

      ._2_5_multidisciplinarity{
        display: var(--display2_5);
      }

      ._3_1_entrepreneurship{
        display: var(--display3_1);
      }

      ._3_2_corporate_collaboration{
        display: var(--display3_2);
      }

      ._3_3_academic_collaboration{
        display: var(--display3_3);
      }

      ._4_1_global_event{
        display: var(--display4_1);
      }

      ._4_2_regional_event{
        display: var(--display4_2);
      }

    </style>

<!--    <parallax-container> -->

    <!-- Alpha message section above timeline -->
    <div class="container flex-horizontal">
      <div style="position: relative; left: 0; top: 0; min-width: 120px;">
        <!-- <img src="/pictures/futureDates.png" style="position: relative; top: 0; left: 0; margin: 50px 70px 30px 26px;"/> -->
        <img src="/pictures/alpha.png" style="position: absolute; top: 0px; left: 0px;"/>
      </div>
      <div class="flexchild">
        <img src="/pictures/title_FIN.png" style="position: relative; top: 20px; left: 0; margin: 60px 0px 60px 0px;"/>

          <div class="container flex-horizontal">
            <div class="flexchild">
              <!--
              <h1 class="info">Welcome!</h1>
              <p class="info">This is a timeline of events from the history of Aalto University and its predecessor schools, that has had an impact for the Finnish society. Here are some historical milestones together with a few impactful chain of events, but this is just a start. Now  we reach out to the community. That is you. Share your insight.</p>
              </br>
              <p class="info">Scroll down the time and suggest a topic you think should be included. Please remember that the perspective here is “a game changer”, so we are looking for themes that have been enablers for disruptions. You can also suggest an anecdote directly regarding an event on the timeline. Thank you for your help.</p>
              -->
              <h1 class="info">Tervetuloa!</h1>
              <p class="info">Aalto-yliopiston aikajana kertoo visuaalisin keinoin tarinoita Muutoksentekijöistä – henkilöistä, tapahtumista tai innovaatioista – Aallon tai sen edeltäjien piirissä. Muutoksentekijöistä, joilla on ollut suuri vaikutus suomalaisen yhteiskunnan kehitykseen.</p>
              </br>
              <p class="info">Aikajana kehittyy vähitellen, joten pyydämme myös sinun panostasi Aallon tarinaan alkaen vuodesta 1849. Kerro visiosi Aallon tulevaisuudesta. Jakaaksesi ajatuksesi liiku aikajanalla haluamaasi vuoteen ja ehdota lisättäväksi aihetta ja taustatietoja. Voit myös kirjoittaa kommenttikenttään anekdootteja jo kuvatuista aiheista. Odotamme panostasi, suurkiitos siitä etukäteen!</p>

            </div>

            <div class="flexchild">
              <!-- Change this to be data driven, get latest video from the API -->
              <h1 class="info">Video of the month</h1>
              <vimeo-player id="videoOfTheMonth" videoid="39189423"></vimeo-player>
              <p class="info">Video Title</p>
              <p class="info">Video Description</p>
            </div>
          </div>

      </div>
    </div>

    <!-- Spinner - hidden after data has loaded
    <paper-spinner-lite class="orange" active></paper-spinner-lite>
    -->
    <!-- Timeline template -->
    <template is="dom-repeat" items="{{eras}}" sort="sortEras">

      <div class="era" style="background:url([[item.images.0.url]]) no-repeat;">

        <p class="eraName"> {{item.name}} </p>
        <!-- <iron-image style="width: 100%; height: 240px;" sizing="cover" src="[[item.images.0.url]]"></iron-image> -->

        <!-- Events template -->
        <template is="dom-repeat" items="{{item.events}}" sort="sortEvents" as="eventItem">

          <!-- <div class="{{eventItem.type}}"> -->
            <div class="_1_1_admin">

            <div class="container flex-horizontal">

            <!-- Column 1 - the year/decade -->
            <div class="year">
              <template is="dom-if" if="{{yearIsFirstInDecade(eventItem.from)}}">
                <div style="font-weight: bold;">{{eventYear(eventItem.from)}}</div>
              </template>
              <template is="dom-if" if="{{!yearIsFirstInDecade(eventItem.from)}}">
                {{eventYear(eventItem.from)}}
              </template>
            </div>

            <!-- Column 2 - comments -->
            <!-- <div class="flexchild"> -->
              <div class="commentColumn">
                <div class="comment" id$="comment{{eventItem.id}}" style="display: none;">
                  <div class="flexchild">

                     <div class="comment-container">

                        <div class="comment-icon">
                          <iron-icon icon="comment"></iron-icon>
                        </div>

                        <div class="comment-text">
                          <template is="dom-repeat" items="{{eventItem.latestPublicComments}}" as="comment">
                            <p>{{comment.notes}}</p>
                            <p style="font-size: 11px;">{{comment.name}}</p>
                          </template>
                        </div>

                    </div>

                  </div>
                  <div class="leftArrow">
                    <img src="/pictures/arrowLeft.png" style="position: relative; top: 0; left: 0; margin: 12px;"/>
                  </div>
                </div>
              </div>
            <!-- </div> -->

            <!-- Column 3 - events -->
            <div class="flexchild">
              <paper-card>
                <div class="event" id="event">
                  <div class="event-header" style$="background-color: [[eventColour(eventItem.type)]];">
                    <paper-button on-tap="handleEventCollapse" style="max-width: 330px; font-family: 'Roboto Condensed', sans-serif; font-weight: bold; text-transform: none;">
                      <iron-icon src="/icns/{{eventItem.type}}.svg" style="margin-right: 8px;"></iron-icon>
                      <span class="buttontext">{{eventItem.name}}</span>
                    </paper-button>
                  </div>
                  <iron-collapse id$="collapse{{eventItem.id}}" style$="width:100%;">
                      <!-- Image div need to be conditional on images being present. also add icon button to go full screen -->
                      <template is="dom-if" if="{{!arrayEmpty(eventItem.images)}}">
                        <div class="event-image">
                          <iron-image style="width: 100%; height: 240px;" sizing="cover" src="[[eventItem.images.0.url]]"></iron-image>
                          <!-- ADD definitiion of Modal to show all images here and icon button to show the modal -->

                          <paper-icon-button src="/icns/fullscreen.svg" on-tap="handleEventCarousel"></paper-icon-button>

                          <paper-dialog id="carouselDialog[[eventItem.id]]" class="carousel-dialog" modal>



                            <image-slider images="{{formatImageArray(eventItem.images)}}" captions="{{formatCaptionArray(eventItem.images)}}"></image-slider>
                            <!-- <div class="buttons"> -->
                              <paper-icon-button class="closeButton" src="/icns/close.svg" dialog-confirm autofocus></paper-icon-button>
                            <!-- </div> -->
                          </paper-dialog>

                        </div>
                      </template>

                      <!-- Vimeo player embed test
                      <template is="dom-if" if="{{arrayEmpty(eventItem.images)}}">
                        <vimeo-player id="my-demo" videoid="39189423"></vimeo-player>
                      </template>
                      -->

                      <div class="event-text">
                         <!-- <div inner-h-t-m-l="{{justText(eventItem.notes)}}"> </div> -->
                         <p style="white-space: pre-line;">{{eventItem.notes}}
                         </p>
                      </div>
                      <div class="event-footer">
                           <paper-button on-tap="handleEventComment">Comment</paper-button>

                          <!-- <paper-button raised onclick="modal{{eventItem.id}}.open()">Comment</paper-button> -->

                          <paper-dialog id="commentDialog[[eventItem.id]]" modal>
                            <p>Please enter your name, email and comment below.</p>
                            <form is="iron-form" id="form[[eventItem.id]]" method="post" content-type="application/json" action="{{getCommentURL}}" on-iron-form-response="handleResponseComment">
                                  <paper-input name="name" label="Name" char-counter maxlength="160" auto-validate error-message="Please enter your name"></paper-input>
                                  <paper-input name="email" label="Email" char-counter maxlength="160" auto-validate error-message="Please enter your email"></paper-input>
                                  <paper-input name="notes" label="Comment" char-counter maxlength="160" auto-validate error-message="Please enter a comment"></paper-input>
                                  <input type="hidden" name="commentedItemId" value="[[eventItem.id]]"/>
                                  <br>
                                  <paper-button dialog-dismiss>Cancel</paper-button>
                                  <paper-button raised autofocus on-tap="submitForm">Submit</paper-button>
                            </form>
                            <div class="buttons">

                            </div>

                          </paper-dialog>

                      </div>
                  </iron-collapse>
                </div>
              </paper-card>
            </div>

            <!-- Column 4 - associations -->
            <div class="flexchild">
              <div class="associationColumn">
                <div class="associations" id$="associations{{eventItem.id}}" style="display: none;">
                  <div class="rightArrow">
                    <img src="/pictures/arrowRight.png" style="position: relative; top: 0; left: 0; margin: 12px;"/>
                  </div>
                  <div class="flexchild">
                    <template is="dom-repeat" items="{{eventItem.associatedItems}}" as="association">
                      <paper-card>
                        <div class="association">
                          <div class="association-header" style$="background-color: {{eventColour(association.type)}};">
                            <paper-button id$="{{association.id}}" on-tap="handleAssociationCollapse" style="max-width: 330px; font-family: 'Roboto Condensed', sans-serif; font-weight: bold; text-transform: none;">
                              <!-- <iron-icon icon={{eventItem.type}} style="margin-right: 8px;"></iron-icon> -->
                              <iron-icon src="/icns/{{association.type}}.svg" style="margin-right: 8px;"></iron-icon>
                              <span class="buttontext">{{association.name}}</span>
                            </paper-button>
                          </div>
                          <iron-collapse id$="associationCollapse{{eventItem.id}}{{association.id}}" style="width:100%;">

                              <template is="dom-if" if="{{!arrayEmpty(association.images)}}">
                                <div class="association-image">
                                  <iron-image style="width: 100%; height: 240px" sizing="cover" src="{{association.images.0.url}}"></iron-image>

                                </div>
                              </template>

                              <div class="association-text">
                                 <!-- <div inner-h-t-m-l="{{justText(association.notes)}}"></div> -->
                                 <p>{{association.notes}}</p>
                              </div>
                          </iron-collapse>

                        </div>
                      </paper-card>
                    </template>
                  </div>
                </div>
              </div>
            </div>

            </div>
          </div>

          </template>

        </div>

    </template>

    <!-- Persistant toast bar used for filter buttons (Maybe add hide/collapsable area for buttons in the toast) -->
    <paper-toast id="toastFilters" duration="0" text="Filters ">
      <paper-icon-button id="1_1" src="/icns/_1_1_admin.svg" on-tap="handleFilter" data-args="1_1" style="background-color: green;"></paper-icon-button>
      <paper-icon-button id="1_2" src="/icns/_1_2_campus.svg" on-tap="handleFilter" data-args="1_2"></paper-icon-button>
      <paper-icon-button id="1_3" src="/icns/_1_3_students.svg" on-tap="handleFilter" data-args="1_3"></paper-icon-button>
      <paper-icon-button id="1_4" src="/icns/_1_4_teaching.svg" on-tap="handleFilter" data-args="1_4"></paper-icon-button>
      <paper-icon-button id="2_1" src="/icns/_2_1_art_and_design.svg" on-tap="handleFilter" data-args="2_1"></paper-icon-button>
      <paper-icon-button id="2_2" src="/icns/_2_2_science_and_technology.svg" on-tap="handleFilter" data-args="2_2"></paper-icon-button>
      <paper-icon-button id="2_3" src="/icns/_2_3_business.svg" on-tap="handleFilter" data-args="2_3"></paper-icon-button>
      <paper-icon-button id="2_4" src="/icns/_2_4_research.svg" on-tap="handleFilter" data-args="2_4"></paper-icon-button>
      <paper-icon-button id="2_5" src="/icns/_2_5_multidisciplinarity.svg" on-tap="handleFilter" data-args="2_5"></paper-icon-button>
      <paper-icon-button id="3_1" src="/icns/_3_1_entrepreneurship.svg" on-tap="handleFilter" data-args="3_1"></paper-icon-button>
      <paper-icon-button id="3_2" src="/icns/_3_2_corporate_collaboration.svg" on-tap="handleFilter" data-args="3_2"></paper-icon-button>
      <paper-icon-button id="3_3" src="/icns/_3_3_academic_collaboration.svg" on-tap="handleFilter" data-args="3_3"></paper-icon-button>
      <paper-icon-button id="4_1" src="/icns/_4_1_global_event.svg" on-tap="handleFilter" data-args="4_1"></paper-icon-button>
      <paper-icon-button id="4_2" src="/icns/_4_2_regional_event.svg" on-tap="handleFilter" data-args="4_2"></paper-icon-button>
    </paper-toast>

    <!--    </parallax-container> -->

    <!-- Initial call to get event data
    <iron-ajax
      id="requestEvents"
      url=""
      handle-as="json"
      on-response="handleResponseEvents">
    </iron-ajax> -->
    <!-- Initial call to get Era data -->
    <iron-ajax
      id="requestEras"
      url=""
      handle-as="json"
      on-response="handleResponseEras">
    </iron-ajax>

  </template>

  <script>
    Polymer({
      is: 'gc-app',

      properties: {
        /**
        * Domain for API calls.
        * @attribute domain
        * @type string
        * @default https://deepamehta.aalto.fi
        */
        domain: {
          type: String,
          //value: 'http://localhost:8080'
          value: 'https://deepamehta.aalto.fi'
        },
        /**
        * Language setting fi=finnish en=english
        * @attribute language
        * @type sting
        * @default fi
        */
        languauge: {
          type: String,
          value: 'fi'
        },
        /**
        * API version string. v1, v2, etc.
        * @attribute version
        * @type sting
        * @default v2
        */
        version: {
          type: String,
          value: 'v2'
        }
      },
      // When ready call API to get all event data
      ready: function(){
        // call function to get video first, display this then get events

        // request events (replaced by get Eras)
        //this.$.requestEvents.url = this.domain + "/gamechangers/" + this.version + "/" + this.languauge + "/events";
        //this.$.requestEvents.generateRequest();

        // request Eras
        this.$.requestEras.url = this.domain + "/gamechangers/" + this.version + "/" + this.languauge + "/eras";
        this.$.requestEras.generateRequest();

        // open the filters toast
        //this.$.toastFilters.open();

        // test code
        //this.$.bottom.scrollIntoView();
      },
      // Function to check if an array is empty
      arrayEmpty: function(array) {
        return array.length == 0;
      },
      // Format the image array for image-slider, just urls, no captions
      formatImageArray: function(array) {
        var imageArray = [];
        for (var i = 0; i < array.length; i++) {
          imageArray[i] = array[i].url;
        }
        return imageArray;
      },
      // Format the captions array for image-slider, just captions, no urls
      formatCaptionArray: function(array) {
        var captionArray = [];
        for (var i = 0; i < array.length; i++) {
          captionArray[i] = array[i].caption;
        }
        return captionArray;
      },
      // Strip HTML tags, specifically img tags from notes
      justText: function(htmlContent) {
        // more efficient to do this in the backend?
        var r = htmlContent.replace(/<img[^>]*>/g,"");
        return r;
      },
      stripURL: function(url){
        console.log ("striping : " + url);
        url = url.replace(/%2F/gi, "/");
        console.log ("stripped : " + url);
        return url;
      },
      getCommentURL: function() {
        //return "http://localhost:8080/gamechangers/v1/comment";
        console.log("domain in getCommentURL : " + this.domain);
        return this.domain + "/gamechangers/v1/comment";
      },
      // Handles data being returned from the API call to get events
      handleResponseEvents: function (data) {
          console.log(data.detail.response);
          this.events = data.detail.response;
      },
      // Handles data being returned from the API call to get eras
      handleResponseEras: function (data) {
          console.log(data.detail.response);
          this.eras = data.detail.response;
      },
      // Event sorting function
      sortEvents: function (a, b) {
          return parseFloat(b.from) - parseFloat(a.from);
      },
      // Era sorting function
      sortEras: function (a, b) {
          return parseFloat(b.from) - parseFloat(a.from);
      },
      // Toggle event cards visibility based on event types
      handleFilter: function(e) {
        var filter = "--display" + e.target.dataset.args;
        var selector = '#' + e.target.dataset.args;

        //console.log("custom display style : " + this.getComputedStyleValue('--testcolour1'));
        console.log("filter : " + filter);
        console.log("calculated display style : " + this.getComputedStyleValue(filter));

/*
        if (this.getComputedStyleValue(filter) == "flex") {
          console.log("hide " + e.target.dataset.args);
          this.customStyle[filter] = "none";
          this.updateStyles();
        } else {
          console.log("show " + e.target.dataset.args);
          this.customStyle[filter] = "flex";
          this.updateStyles();
        }
*/
          this.customStyle["--test1_1"] = "none";
          this.updateStyles();
      },
      // Toggle event card collapse on tap based on ID
      handleEventCollapse: function(event, detail, sender) {
        var id = event.model.eventItem.id;
        var selector = '#collapse' + id;
        var commentDiv = '#comment' + id;
        var associationsDiv = '#associations' + id;
        if (this.$$(selector).opened) {
          this.$$(commentDiv).style.display='none'
          this.$$(associationsDiv).style.display='none'
        } else {
          this.$$(commentDiv).style.display='flex'
          this.$$(associationsDiv).style.display='flex'
        }
        this.$$(selector).toggle();
      },
      // Toggle association card collapse on tap based on ID
      handleAssociationCollapse: function(event, detail, sender) {
        //console.log("association id" + event.model.association.id);
        var id = event.model.eventItem.id;
        var associationId = event.model.association.id;
        var card = '#associationCollapse' + id + associationId;
        this.$$(card).toggle();
      },
      handleEventComment: function(event, detail, sender) {
        //console.log("comment tap event");
        var id = event.model.eventItem.id;
        console.log("open comment dialog for event : " + id);
        var dialog = '#commentDialog' + id;
        this.$$(dialog).open();
      },
      // Open carousel dialog when full screen button is tapped
      handleEventCarousel: function(event, detail, sender) {
        console.log("full screen tap event");
        var id = event.model.eventItem.id;
        console.log("open image carousel dialog for event : " + id);
        var dialog = '#carouselDialog' + id;
        this.$$(dialog).open();
      },
      // Handle response from API after comment, display message close dialog on success.
      handleResponseComment: function (data) {
        var id = event.model.eventItem.id;
        console.log("close comment dialog for event : " + id);
        console.log("comment response : " + JSON.stringify(data.detail.response));
        console.log("comment response id " + data.detail.response.id);

        var dialog = '#commentDialog' + id;
        this.$$(dialog).close();
        alert ("Comment submitted. Thank you.");
      },
      // function used to submit forms (comment/propose) with paper-button
      submitForm: function(event) {
        var form = event.target.parentElement;
        //console.log("1 " + event.target.parentElement , typeof(event.target.parentElement)); //));
        // work around to change method to PUT before submitting
        form.addEventListener('iron-form-presubmit', function() {
          //console.log("pre-submit form function called");
          this.request.method = 'PUT';
          this.request.url =  'https://deepamehta.aalto.fi/gamechangers/v1/comment';
          this.request.handleAs = 'json';
          //console.log(this.serialize());
        });
        //form.addEventListener('iron-form-submit', function(event) {
          //console.log("submit form function called");
          //console.log (JSON.stringify(event.detail));
        //});
        form.addEventListener('iron-form-error', function(event) {
          //console.log("comment form error response");
          alert ("Comment failed. Please make sure you entered your name, a comment and a valid email then try again");
        });
        //console.log("submit form function called : ") ;
        form.submit();
      },
      // return the colour based on suplied event type
      eventColour: function (type) {
        var c;
        switch (type) {
          case "_1_1_admin":
              c = "#5677FC";
              break;
          case "_1_2_campus":
              c = "#5677FC";
              break;
          case "_1_3_students":
              c = "#5677FC";
              break;
          case "_1_4_teaching":
              c = "#5677FC";
              break;

          case "_2_1_art_and_design":
              c = "#EC407A";
              break;
          case "_2_2_science_and_technology":
              c = "#EC407A";
              break;
          case "_2_3_business":
              c = "#EC407A";
              break;
          case "_2_4_research":
              c = "#EC407A";
              break;
          case "_2_5_multidisciplinarity":
              c = "#EC407A";
              break;

          case "_3_1_entrepreneurship":
              c = "#FF9800";
              break;
          case "_3_2_corporate_collaboration":
              c = "#FF9800";
              break;
          case "_3_3_academic_collaboration":
              c = "#FF9800";
              break;

          case "_4_1_global_event":
              c = "#7ED321";
              break;
          case "_4_2_regional_event":
              c = "#7ED321";
              break;

          default:
              c = "#9B9B9B";
        }
        return c;
      },
      // return year string of timestamp supplied  *** change this to only return the first instance of each year
      // ie use global array to keep track of already returned years and not return those strings
      // Also need to use  var n = str.endsWith("0"); to check for decades, so decade can have larger font size.
      eventYear: function (timestamp) {
        var d = new Date(timestamp);
        return d.getFullYear();
      },
      // Return true if the year end in 0, i.e. first in a decade
      yearIsFirstInDecade: function (timestamp) {
        var d = new Date(timestamp);
        var y = d.getFullYear();
        var s = y.toString();
        var l = s.substr(s.length - 1);
        return l == "0";
      }
    });
  </script>

</dom-module>
