<!-- Polymer elements -->
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<!-- Community elements-->
<link rel="import" href="../bower_components/parallax-container/parallax-container.html">
<!-- Project elements-->
<link rel="import" href="gc-icons.html">
<link rel="import" href="gc-styles.html">
<link rel="import" href="vimeo-player.html">

<dom-module id="gc-app">
  <template>
    <style include="gc-styles">
      :host {
        --app-primary-color: white;
        --app-secondary-color: black;

        display: block;
        padding: 0px;
        overflow: hidden;
      }
    </style>

<!--    <parallax-container> -->

    <!-- Alpha message section above timeline -->
    <div class="container flex-horizontal">
      <div style="position: relative; left: 0; top: 0;">
        <img src="/pictures/futureDates.png" style="position: relative; top: 0; left: 0; margin: 50px 70px 30px 26px;"/>
        <img src="/pictures/alpha.png" style="position: absolute; top: 0px; left: 0px;"/>
      </div>
      <div class="flexchild">
        <img src="/pictures/title.png" style="position: relative; top: 20px; left: 0; margin: 60px 0px 60px 0px;"/>
        <p class="info" >CLOSED ALPHA - VERSION</p>
        <div style="height: 1px; background-color: #F8E81C;"></div>

          <div class="container flex-horizontal">
            <div class="flexchild">
              <h1 style="color: #F8E81C; font-size: 64px;">Dear Alpha,</h1>
              <p class="info">You are among select few who are given early access for Aalto Gamechangers website. We are gathering a timeline of events from the history of Aalto University and its predecessor schools, that has
      had an impact for the Finnish society. We ask you to browse through the  preliminary content, comment with an anecdote or a insight relating to them or propose a new thing with a year that you think should be included. Please remember that the perspective here is “gamechanger”, so we are looking for things that had enabled lot of other things and fundamentelly multidiciplinary. Thank you.</p>
              </div>
            <div class="flexchild">
              <p></p>
            </div>
          </div>
      </div>
    </div>

    <!-- Timeline template -->
    <template is="dom-repeat" items="{{events}}" sort="sortEvents">

      <div class="container flex-horizontal">

        <!-- Column 1 - the year/decade -->
        <div class="year">
          <template is="dom-if" if="{{yearIsFirstInDecade(item.from)}}">
            <div style="font-weight: bold;">{{eventYear(item.from)}}</div>
          </template>
          <template is="dom-if" if="{{!yearIsFirstInDecade(item.from)}}">
            {{eventYear(item.from)}}
          </template>
        </div>

        <!-- Column 2 - comments -->
        <div class="flexchild">
          <div class="commentColumn">
            <div class="comment" id$="comment{{item.id}}" style="display: none;">
              <div class="flexchild">

                 <div class="comment-container">

                    <div class="comment-icon">
                      <iron-icon icon="comment"></iron-icon>
                    </div>

                    <div class="comment-text">
                      <template is="dom-repeat" items="{{item.latestPublicComments}}" as="comment">
                        <p style="font-size: 18px;">{{comment.notes}}</p>
                        <p style="font-size: 11px;">{{comment.name}}</p>
                      </template>
                    </div>

                </div>

              </div>
              <div class="leftArrow">
                <img src="/pictures/arrowLeft.png" style="position: relative; top: 0; left: 0; margin: 12px;"/>
              </div>
            </div>
          </div>
        </div>

        <!-- Column 3 - events -->
        <div class="flexchild">
          <paper-card>
            <div class="event" id="event">
              <div class="event-header" style$="background-color: [[eventColour(item.type)]];">
                <paper-button on-tap="handleEventCollapse" style="max-width: 330px; font-family: 'Roboto Condensed', sans-serif; font-weight: bold; text-transform: none;">
                  <iron-icon icon={{item.type}} style="margin-right: 8px;"></iron-icon>
                  <span class="buttontext">{{item.name}}</span>
                </paper-button>
              </div>
              <iron-collapse id$="collapse{{item.id}}" style$="width:100%;">
                  <!-- Image div need to be conditional on images being present. also add icon button to go full screen -->
                  <template is="dom-if" if="{{!arrayEmpty(item.images)}}">
                    <div class="event-image">
                      <iron-image style="width: 100%; height: 240px;" sizing="cover" src="[[item.images.0.url]]"></iron-image>
                      <!-- ADD definitiion of Modal to show all images here and icon button to show the modal -->
                    </div>
                  </template>

                  <!-- Vimeo player embed test
                  <template is="dom-if" if="{{arrayEmpty(item.images)}}">
                    <vimeo-player id="my-demo" videoid="39189423"></vimeo-player>
                  </template>
                  -->

                  <div class="event-text">
                     <!-- <div inner-h-t-m-l="{{justText(item.notes)}}"> </div> -->
                     <p style="white-space: pre-line;">{{item.notes}}
                     </p>
                  </div>
                  <div class="event-footer">
                       <paper-button on-tap="handleEventComment">Comment</paper-button>

                      <!-- <paper-button raised onclick="modal{{item.id}}.open()">Comment</paper-button> -->

                      <paper-dialog id="commentDialog[[item.id]]" modal>
                        <p>Please enter your name, email and comment below.</p>
                        <form is="iron-form" id="form[[item.id]]" method="post" content-type="application/json" action="{{getCommentURL}}">
                              <paper-input name="name" label="Name" char-counter maxlength="160" auto-validate error-message="Please enter your name"></paper-input>
                              <paper-input name="email" label="Email" char-counter maxlength="160" auto-validate error-message="Please enter your email"></paper-input>
                              <paper-input name="notes" label="Comment" char-counter maxlength="160" auto-validate error-message="Please enter a comment"></paper-input>
                              <input type="hidden" name="commentedItemId" value="[[item.id]]"/>
                              <br>
                              <paper-button dialog-dismiss>Cancel</paper-button>
                              <paper-button raised autofocus on-tap="submitForm">Submit</paper-button>
                        </form>
                        <div class="buttons">

                        </div>

                      </paper-dialog>

                  </div>
              </iron-collapse>
            </div>
          </paper-card>
        </div>

        <!-- Column 4 - associations -->
        <div class="flexchild">
          <div class="associationColumn">
            <div class="associations" id$="associations{{item.id}}" style="display: none;">
              <div class="rightArrow">
                <img src="/pictures/arrowRight.png" style="position: relative; top: 0; left: 0; margin: 12px;"/>
              </div>
              <div class="flexchild">
                <template is="dom-repeat" items="{{item.associatedItems}}" as="association">
                  <paper-card>
                    <div class="association">
                      <div class="association-header" style$="background-color: {{eventColour(association.type)}};">
                        <paper-button id$="{{association.id}}" on-tap="handleAssociationCollapse" style="max-width: 330px; font-family: 'Roboto Condensed', sans-serif; font-weight: bold; text-transform: none;">
                          <iron-icon icon={{item.type}} style="margin-right: 8px;"></iron-icon>
                          <span class="buttontext">{{association.name}}</span>
                        </paper-button>
                      </div>
                      <iron-collapse id$="associationCollapse{{item.id}}{{association.id}}" style="width:100%;">

                          <template is="dom-if" if="{{!arrayEmpty(association.images)}}">
                            <div class="association-image">
                              <iron-image style="width: 100%; height: 240px;" sizing="cover" src="{{item.images.0.url}}"></iron-image>

                            </div>
                          </template>

                          <div class="association-text">
                             <!-- <div inner-h-t-m-l="{{justText(association.notes)}}"></div> -->
                             <p>{{association.notes}}</p>
                          </div>
                      </iron-collapse>

                    </div>
                  </paper-card>
                </template>
              </div>
            </div>
          </div>
        </div>

      </div>
    </template>

    <!--    </parallax-container> -->

    <!-- Initial call to get event data -->
    <iron-ajax
      id="requestEvents"
      url=""
      handle-as="json"
      on-response="handleResponse">
    </iron-ajax>

  </template>

  <script>
    Polymer({
      is: 'gc-app',

      properties: {
        /**
        * Domain for API calls.
        * @attribute domain
        * @type string
        * @default http://localhost:8080
        */
        domain: {
          type: String,
          //value: 'http://localhost:8080'
          value: 'https://deepamehta.aalto.fi'
        },
        /**
        * Language setting fi=finnish en=english
        * @attribute language
        * @type sting
        * @default fi
        */
        languauge: {
          type: String,
          value: 'fi'
        },
        /**
        * API version string. v1, v2, etc.
        * @attribute version
        * @type sting
        * @default v2
        */
        version: {
          type: String,
          value: 'v2'
        }
      },
      // When ready call API to get all event data
      ready: function(){
        //document.domain = 'aalto.fi'; // NOTE: test if this is needed once deployed or not?
        //document.domain = 'localhost';
        this.$.requestEvents.url = this.domain + "/gamechangers/" + this.version + "/" + this.languauge + "/events";
        this.$.requestEvents.generateRequest();

        // test code
        //this.$.bottom.scrollIntoView();

      },
      // Function to check if an array is empty
      arrayEmpty: function(array) {
        return array.length == 0;
      },
      // Strip HTML tags, specifically img tags from notes
      justText: function(htmlContent) {
        // more efficient to do this in the backend?
        var r = htmlContent.replace(/<img[^>]*>/g,"");
        return r;
      },
      stripURL: function(url){
        console.log ("striping : " + url);
        url = url.replace(/%2F/gi, "/");
        console.log ("stripped : " + url);
        return url;
      },
      getCommentURL: function() {
        //return "http://localhost:8080/gamechangers/v1/comment";
        return this.domain + "/gamechangers/v1/comment";
      },
      // Handles data being returned from the API call to get events
      handleResponse: function (data) {
          console.log(data.detail.response);
          this.events = data.detail.response;
      },
      sortEvents: function (a, b) {
          return parseFloat(b.from) - parseFloat(a.from);
      },
      // Toggle event card collapse on tap based on ID
      handleEventCollapse: function(event, detail, sender) {
        var id = event.model.item.id;
        var selector = '#collapse' + id;
        var commentDiv = '#comment' + id;
        var associationsDiv = '#associations' + id;
        if (this.$$(selector).opened) {
          this.$$(commentDiv).style.display='none'
          this.$$(associationsDiv).style.display='none'
        } else {
          this.$$(commentDiv).style.display='flex'
          this.$$(associationsDiv).style.display='flex'
        }
        this.$$(selector).toggle();
      },
      // Toggle association card collapse on tap based on ID
      handleAssociationCollapse: function(event, detail, sender) {
        //console.log("association id" + event.model.association.id);
        var id = event.model.item.id;
        var associationId = event.model.association.id;
        var card = '#associationCollapse' + id + associationId;
        this.$$(card).toggle();
      },
      handleEventComment: function(event, detail, sender) {
        //console.log("comment tap event");
        // add comment ajax call
        var id = event.model.item.id;
        console.log("open comment dialog for event : " + id);
        var dialog = '#commentDialog' + id;
        this.$$(dialog).open();
      },
      // function used to submit forms (comment/propose) with paper-button
      submitForm: function(event) {

        var form = event.target.parentElement;

        //console.log("1 " + event.target.parentElement , typeof(event.target.parentElement)); //));

        // work around to change method to PUT before submitting

        form.addEventListener('iron-form-presubmit', function() {
          console.log("pre-submit form function called");
          this.request.method = 'PUT';
          //this.request.url = 'http://localhost:8080/gamechangers/v1/comment';
          this.request.url =  'https://deepamehta.aalto.fi/gamechangers/v1/comment';
          this.request.handleAs = 'json';
          //console.log("name : " + this.getAttribute('id') );
          console.log("this comment domain : " + this.domain);
          console.log(this.serialize());
        });

        form.addEventListener('iron-form-submit', function(event) {
          console.log (JSON.stringify(event.detail));
        });

        console.log("submit form function called : ") ;
        //console.log(form, typeof(form));
        form.submit();
      },
      // return the colour based on suplied event type
      eventColour: function (type) {
        var c;
        switch (type) {
          case "1_1 admin":
              c = "#5677FC";
              break;
          case "1_2 campus":
              c = "#5677FC";
              break;
          case "1_3 students":
              c = "#5677FC";
              break;
          case "1_4 teaching":
              c = "#5677FC";
              break;

          case "2_1 art and design":
              c = "#EC407A";
              break;
          case "2_2 science and technology":
              c = "#EC407A";
              break;
          case "2_3 business":
              c = "#EC407A";
              break;
          case "2_4 research":
              c = "#EC407A";
              break;
          case "2_5 multidisciplinarity":
              c = "#EC407A";
              break;

          case "3_1 entrepreneurship":
              c = "#FF9800";
              break;
          case "3_2 corporate collaboration":
              c = "#FF9800";
              break;
          case "3_3 academic collaboration":
              c = "#FF9800";
              break;

          case "4_1 global event":
              c = "#7ED321";
              break;
          case "4_2 regional event":
              c = "#7ED321";
              break;

          default:
              c = "#9B9B9B";
        }
        return c;
      },
      // return year string of timestamp supplied  *** change this to only return the first instance of each year
      // ie use global array to keep track of already returned years and not return those strings
      // Also need to use  var n = str.endsWith("0"); to check for decades, so decade can have larger font size.
      eventYear: function (timestamp) {
        var d = new Date(timestamp);
        return d.getFullYear();
      },
      // Return true if the year end in 0, i.e. first in a decade
      yearIsFirstInDecade: function (timestamp) {
        var d = new Date(timestamp);
        var y = d.getFullYear();
        var s = y.toString();
        var l = s.substr(s.length - 1);
        return l == "0";
      }
    });
  </script>

</dom-module>
