<!-- Polymer elements -->
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/iron-localstorage/iron-localstorage.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner-lite.html">
<!-- Community elements-->
<link rel="import" href="../bower_components/parallax-container/parallax-container.html">
<link rel="import" href="vimeo-player.html">
<link rel="import" href="image-slider.html">
<!-- Project elements-->
<link rel="import" href="gc-icons.html">
<link rel="import" href="gc-styles.html">

<dom-module id="gc-app">
  <template>
    <style include="gc-styles">
      :host {
        --app-primary-color: white;
        --app-secondary-color: black;
        display: block;
        padding: 0px;
        overflow: hidden;
        font-family: Arial, "Helvetica Neue", Helvetica, sans-serif;
        font-weight: normal;
        iron-image {
          --iron-image-width: 100%;
        }
      }

      .video-of-the-month {
        width: 90%;
      }

      .event-video {
        width: 100%;
      }
    </style>

    <!-- Language settings local storage -->
    <iron-localstorage
      name="gamechangers-storage"
      value="{{storage}}"
      on-iron-localstorage-load-empty="initializeDefaultStorage"
      on-iron-localstorage-load="handleLocalstorageLoadEvent"
    ></iron-localstorage>

    <!-- app route. Query params used for deep linking -->
    <app-location route="{{route}}" query-params="{{queryParams}}"></app-location>

    <!-- Load video of the month vimeo ID -->
    <iron-ajax
      id="requestVideoOfTheMonth"
      url="https://deepamehta.aalto.fi/gamechangers/v1/featured_video"
      handle-as="json"
      on-response="handleResponseVideoOfTheMonth">
    </iron-ajax>

    <iron-media-query query="(min-width: 900px)" query-matches="{{largeViewport}}"></iron-media-query>
<!--    <parallax-container> -->

    <!-- Alpha message section above timeline -->
    <template is="dom-if" if="{{storageLoaded}}">

      <!-- Language change and credits buttons -->
      <div class="menuButtons">
        <paper-button on-tap="changeLanguage">{{storage.label}}</paper-button>
        <paper-button on-tap="openCreditsDialog">Credits</paper-button>
        <paper-dialog class="credits-dialog" id="creditsDialog">

           <div class="container flex-horizontal">
             <div class="credits">
               <template is="dom-if" if="{{languageFinnish()}}">
                 <h1 class="credits">Kuvakrediitit</h1>
                 <p class="credits">Kiitämme lämpimästi useita suomalaisia toimijoita heidän Creative Commons tai Public Domain kuva-arkistoistaan. Aikajanan historialliset kuvat on saatu seuraavista kokoelmista:</p>
                 <p class="credits">Museovirasto<br>
                    Suomen valokuvataiteen museo<br>
                    Yleisradio<br>
                    Aalto University Commons<br>
                    Svenska litteratursällskapet i Finland</p>
                 <p class="credits">Kuvaajat:<br>
                   Aino Huovio<br>
                  ALA Arkkitehdit<br>
                  Gustaf Sandberg<br>
                  Helge Heinonen<br>
                  I.K. Inha<br>
                  Matt Britt<br>
                  Matti Tirri<br>
                  Mikko Raskinen<br>
                  T. H. Järvi<br>
                  Tuomas Uusheimo</p>
               </template>
               <template is="dom-if" if="{{!languageFinnish()}}">
                 <h1 class="credits">Photo credits</h1>
                 <p class="credits">We are grateful of the selections of Creative Commons or Public Domain image collections provided by groving number of Finnish institutions.</p>
                 <p class="credits">Historical images of this timeline are from collections by:<br>
                    National Board of Antiquities<br>
                    The Finnish Museum of Photography<br>
                    The Finnish Broadcasting Company<br>
                    Aalto University Commons<br>
                    The Society of Swedish Literature in Finland</p>
                 <p class="credits">Images from:<br>
                  Aino Huovio<br>
                  ALA Arkkitehdit<br>
                  Gustaf Sandberg<br>
                  Helge Heinonen<br>
                  I.K. Inha<br>
                  Matt Britt<br>
                  Matti Tirri<br>
                  Mikko Raskinen<br>
                  T. H. Järvi<br>
                  Tuomas Uusheimo</p>
               </template>
             </div>
             <div class="credits">
               <template is="dom-if" if="{{languageFinnish()}}">
                 <h1 class="credits">Työryhmä</h1>
                 <p class="credits">Aalto-yliopiston Suomi 100 -ohjausryhmä</p>
                  <p class="credits">Tuottaja<br>
                  Tatu Pohjola<br><br>
                  Sisältötiimi<br>
                  Sampsa Kaataja<br>
                  Heli Laukko<br>
                  Eeva Lehtinen<br>
                  Panu Nykänen<br>
                  Terhi Olllikainen<br>
                  Mikko Raskinen<br>
                  Anu Salmi-Savilampi<br>
                  Laura Siira<br>
                  Tuuli Sotamaa<br><br>
                  Verkkosovellus<br>
                  Tuomo Tammenpää<br>
                  Daniel Blackburn<br>
                  Jürgen Neumann<br>
                  Robert Schuster<br><br>
                  IT-tuki<br>
                  Mika Niemi<br><br>
                  Fyysinen aikajana (Otakaari 1, Otaniemi kampus)<br>
                  Akbar Khatir<br>
                  Maria Levina<br><br>
                  Aalto Muutoksentekijät -aikajana backend is powered by<br>
                  Deepamehta.de</p>
               </template>
               <template is="dom-if" if="{{!languageFinnish()}}">
                 <h1 class="credits">Team</h1>
                 <p class="credits">Aalto University Finland 100 Steering group</p>
                  <p class="credits">Producer<br>
                  Tatu Pohjola<br><br>
                  Content team<br>
                  Sampsa Kaataja<br>
                  Heli Laukko<br>
                  Eeva Lehtinen<br>
                  Panu Nykänen<br>
                  Terhi Olllikainen<br>
                  Mikko Raskinen<br>
                  Anu Salmi-Savilampi<br>
                  Laura Siira<br>
                  Tuuli Sotamaa<br><br>
                  Webapp<br>
                  Tuomo Tammenpää<br>
                  Daniel Blackburn<br>
                  Jürgen Neumann<br>
                  Robert Schuster<br><br>
                  IT support<br>
                  Mika Niemi<br><br>
                  Physical Timeline (Otakaari 1, Otaniemi campus)<br>
                  Akbar Khatir<br>
                  Maria Levina<br><br>
                  Aalto Game Changers backend is powered by<br>
                  Deepamehta.de</p>
               </template>
             </div>
           </div>

           <paper-icon-button class="closeButton" icon="close" dialog-confirm autofocus></paper-icon-button>

        </paper-dialog>
      </div>

      <div class="container flex-horizontal">
        <div style="position: relative; left: 0; top: 0; min-width: 120px;">
          <!-- <img src="/pictures/futureDates.png" style="position: relative; top: 0; left: 0; margin: 50px 70px 30px 26px;"/> -->
          <img src="/pictures/beta.png" style="position: absolute; top: 0px; left: 0px;"/>
        </div>
        <div class="flexchild">
          <template is="dom-if" if="{{largeViewport}}">
            <img src="/pictures/{{localisedTitle()}}" style="position: relative; top: 20px; left: 0; margin: 60px 0px 60px 0px;"/>
          </template>
          <template is="dom-if" if="{{!largeViewport}}">
            <img src="/pictures/{{localisedTitleMobile()}}" style="position: relative; top: 20px; left: 0; margin: 60px 0px 60px 0px;"/>
          </template>
            <div class="container flex-horizontal">
              <div class="flexchild">
                <h1 class="info">{{localisedH1()}}</h1>
                <p class="info">{{localisedP1()}}</p>
                </br>
                <p class="info">{{localisedP2()}}</p>
                </br>
                <paper-button on-tap="handleEventPropose" style="background-color: #F8E81C; border-radius: 0; margin: 0;">{{localisedPropose()}}</paper-button>
                <paper-dialog class="input-dialog" id="proposeDialog" modal>
                   <p>{{localisedProposeDescription()}}</p>
                   <form is="iron-form" id="propose" method="post" content-type="application/json" action="{{getProposeURL}}" on-iron-form-response="handleResponsePropose">
                         <paper-input name="name" label="{{localisedName()}}" char-counter maxlength="160" auto-validate error-message="Please enter your name"></paper-input>
                         <paper-input name="email" label="{{localisedEmail()}}" char-counter maxlength="160" auto-validate error-message="Please enter your email"></paper-input>
                         <paper-input name="notes" label="{{localisedPropose()}}" char-counter maxlength="160" auto-validate error-message="Please enter your proposal"></paper-input>
                         <input type="hidden" name="from" value="972408544247">
                         <input type="hidden" name="to" value="1477330144247">
                         <br>
                         <paper-button dialog-dismiss>{{localisedCancel()}}</paper-button>
                         <paper-button raised autofocus on-tap="submitProposal">{{localisedSubmit()}}</paper-button>
                   </form>
                </paper-dialog>
                </br>
                </br>
                <h1 class="info">{{localisedVideoH1()}}</h1>
                <div class="video-of-the-month">
                  <vimeo-player id="videoOfTheMonth" videoid="{{videoOfTheMonth}}"></vimeo-player>
                </div>
                <p class="info"> </p>
                <p class="info"> </p>
                </br>
              </div>
              <div class="flexchild">
                </br>
              </div>
            </div>
        </div>
      </div>
    </template>

    <!-- Spinner - hidden after data has loaded -->
    <paper-spinner-lite active id="spinner" alt="Loading timeline"></paper-spinner-lite>

    <!-- Timeline template -->
    <div id="timeline" on-dom-change="eraDOM" style="margin-right: 8px">
    <template  is="dom-repeat" items="{{eras}}" initial-count="8" sort="sortEras" >

      <!-- <div class="era" style="background:url([[item.images.0.url]]) no-repeat;"> -->
      <div class="era" style="background-image: url([[arrayItem(item.images.*, 0,'url')]]); background-repeat: no-repeat;">

        <p class="eraName"> {{item.name}} </p>

        <!-- Events template -->
        <template is="dom-repeat" items="{{item.events}}" sort="sortEvents" as="eventItem">

          <template is="dom-if" if="{{filtered(eventItem.type,filterChanged)}}">

          <div class$="[[eventItem.type]]" id$="eventDiv[[eventItem.id]]">
           <div class="container flex-horizontal">

            <!-- Column 1 - the year/decade -->
            <div class="year">
              <template is="dom-if" if="{{yearIsFirstInDecade(eventItem.from)}}">
                <div style="font-weight: bold;">{{eventYear(eventItem.from)}}</div>
              </template>
              <template is="dom-if" if="{{!yearIsFirstInDecade(eventItem.from)}}">
                {{eventYear(eventItem.from)}}
              </template>
            </div>

            <!-- Column 2 - comments -->
            <template is="dom-if" if="{{largeViewport}}">
              <div class="flexchild">
                <div class="commentColumn">
                  <div class="comment" id$="comment{{eventItem.id}}" style="display: none;">
                    <div class="flexchild">

                       <div class="comment-container">

                          <div class="comment-icon">
                            <iron-icon icon="comment"></iron-icon>
                          </div>

                          <div class="comment-text">
                            <template is="dom-repeat" items="{{eventItem.latestPublicComments}}" as="comment">
                              <p>{{comment.notes}}</p>
                              <p style="font-size: 11px;">{{comment.name}}</p>
                            </template>
                          </div>

                      </div>

                    </div>
                    <div class="leftArrow">
                      <img src="/pictures/arrowLeft.png" style="position: relative; top: 0; left: 0; margin: 12px;"/>
                    </div>
                  </div>
                </div>
              </div>
            </template>

            <!-- Column 3 - events -->
            <div class="flexchild">
              <paper-card>
                <div class="event" id="event">
                  <div class="event-header" style$="background-color: [[eventColour(eventItem.type)]];">
                    <paper-button on-tap="handleEventCollapse" style="max-width: 330px;">
                      <iron-icon src="/icns/{{eventItem.type}}.svg" style="margin-right: 8px;"></iron-icon>
                      <span class="buttontext">{{eventItem.name}}</span>
                    </paper-button>
                  </div>
                  <iron-collapse id$="collapse{{eventItem.id}}" style="width:100%;">
                      <!-- Image div need to be conditional on images being present. also add icon button to go full screen -->
                      <template is="dom-if" if="{{!arrayEmpty(eventItem.images)}}">
                        <div class="event-image">
                          <iron-image style="width: 100%; height: 240px;" sizing="cover" src="[[eventItem.images.0.url]]"></iron-image>
                          <!-- ADD definitiion of Modal to show all images here and icon button to show the modal -->

                          <paper-icon-button id="fullscreen-button" src="/icns/fullscreen.svg" on-tap="handleEventCarousel"></paper-icon-button>

                          <paper-dialog id="carouselDialog[[eventItem.id]]" class="carousel-dialog" modal>
                            <image-slider images="{{formatImageArray(eventItem.images)}}" captions="{{formatCaptionArray(eventItem.images)}}"></image-slider>
                            <!-- <div class="buttons"> -->
                              <paper-icon-button class="closeButton" icon="close" dialog-confirm autofocus></paper-icon-button>
                            <!-- </div> -->
                          </paper-dialog>

                        </div>
                      </template>

                      <!-- Vimeo player embed test -->
                      <template is="dom-if" if="{{eventItem.vimeoVideoId}}">
                        <div class="event-video">
                          <vimeo-player id="video{{eventItem.vimeoVideoId}}" videoid="{{eventItem.vimeoVideoId}}"></vimeo-player>
                        </div>
                      </template>

                      <div class="event-text">
                         <!-- <div inner-h-t-m-l="{{justText(eventItem.notes)}}"> </div> -->
                         <p>{{eventYear(eventItem.from)}}</p>
                         <p style="font-weight: bold;">{{eventItem.name}}</p>
                         <p>{{eventItem.notes}}
                         </p>
                      </div>
                      <div class="event-footer">
                           <div class="buttons">
                             <paper-icon-button id="comment-button" icon="comment" on-tap="handleEventComment"></paper-icon-button>
                             <paper-icon-button id="share-button" icon="share" on-tap="handleEventShare"></paper-icon-button>
                          </div>
                          <paper-dialog class="input-dialog" id="commentDialog[[eventItem.id]]" modal>
                            <p>{{localisedCommentDescription()}}</p>
                            <form is="iron-form" id="form[[eventItem.id]]" method="post" content-type="application/json" action="{{getCommentURL}}" on-iron-form-response="handleResponseComment">
                                  <paper-input name="name" label="{{localisedName()}}" char-counter maxlength="160" auto-validate error-message="Please enter your name"></paper-input>
                                  <paper-input name="email" label="{{localisedEmail()}}" char-counter maxlength="160" auto-validate error-message="Please enter your email"></paper-input>
                                  <paper-input name="notes" label="{{localisedComment()}}" char-counter maxlength="160" auto-validate error-message="Please enter a comment"></paper-input>
                                  <input type="hidden" name="commentedItemId" value="[[eventItem.id]]">
                                  <br>
                                  <paper-button dialog-dismiss>{{localisedCancel()}}</paper-button>
                                  <paper-button raised autofocus on-tap="submitComment">{{localisedSubmit()}}</paper-button>
                            </form>
                          </paper-dialog>
                          <paper-dialog class="share-dialog" id="shareDialog[[eventItem.id]]">
                            <p>{{localisedShareDescription()}}</p>
                            <textarea id="shareText[[eventItem.id]]" rows="1" cols="50">https://gamechangers.aalto.fi/?event=[[eventItem.id]]</textarea>
                            <p> </p>
                          </paper-dialog>

                      </div>
                  </iron-collapse>
                </div>
              </paper-card>
            </div>

            <!-- Column 4 - associations -->
            <div class="flexchild">
              <div class="association-column">
                <div class="events" id$="associations{{eventItem.id}}" style="display: none;">
                  <div class="rightArrow">
                    <img src="/pictures/arrowRight.png" style="position: relative; top: 0; left: 0; margin: 12px;"/>
                  </div>
                  <div class="flexchild">
                    <template is="dom-repeat" items="{{eventItem.associatedItems}}" sort="sortEvents" as="association">
                      <paper-card>
                        <div class="event">
                          <div class="event-header" style$="background-color: {{eventColour(association.type)}};">
                            <paper-button id$="{{association.id}}" on-tap="handleAssociationCollapse" style="max-width: 330px;">
                              <template is="dom-if" if="{{association.type}}">
                                <iron-icon src="/icns/{{association.type}}.svg" style="margin-right: 8px;"></iron-icon>
                              </template>
                              <template is="dom-if" if="{{!association.type}}">
                                <iron-icon src="/icns/{{association._type}}.svg" style="margin-right: 8px;"></iron-icon>
                              </template>
                              <span class="buttontext">{{association.name}}</span>
                            </paper-button>
                          </div>
                          <iron-collapse id$="associationCollapse{{eventItem.id}}{{association.id}}" style="width:100%;">

                              <template is="dom-if" if="{{!arrayEmpty(association.images)}}">
                                <div class="event-image">
                                  <iron-image style="width: 100%; height: 240px" sizing="cover" src="{{association.images.0.url}}"></iron-image>

                                </div>
                              </template>

                              <!-- Vimeo player embed test -->
                              <template is="dom-if" if="{{association.vimeoVideoId}}">
                                <div class="event-video">
                                  <vimeo-player id="video{{association.vimeoVideoId}}" videoid="{{association.vimeoVideoId}}"></vimeo-player>
                                </div>
                              </template>

                              <div class="event-text">
                                <template is="dom-if" if="{{association.from}}">
                                 <p>{{eventYear(association.from)}}</p>
                               </template>
                                 <p style="font-weight: bold;">{{association.name}}</p>
                                 <p>{{association.notes}}</p>
                              </div>
                          </iron-collapse>

                        </div>
                      </paper-card>
                    </template>
                  </div>
                </div>
              </div>
            </div>

           </div>
          </div>
          </template>
          </template>

        </div>

    </template>
  </div>

  <div style="background: url('/pictures/BG_footer.png') no-repeat; height: 519px; min-height: 519px;">

  </div>

  <!-- Persistant toast bar used for filter buttons (Maybe add hide/collapsable area for buttons in the toast) -->
    <paper-toast id="toastFilters" duration="0" text="">
      <paper-icon-button id="filter_button_1_1" src="/icns/_1_1_admin.svg" on-tap="handleFilter1_1"></paper-icon-button>
      <paper-icon-button id="filter_button_1_2" src="/icns/_1_2_campus.svg" on-tap="handleFilter1_2"></paper-icon-button>
      <paper-icon-button id="filter_button_1_3" src="/icns/_1_3_students.svg" on-tap="handleFilter1_3"></paper-icon-button>
      <paper-icon-button id="filter_button_1_4" src="/icns/_1_4_teaching.svg" on-tap="handleFilter1_4"></paper-icon-button>
      <paper-icon-button id="filter_button_2_1" src="/icns/_2_1_art_and_design.svg" on-tap="handleFilter2_1"></paper-icon-button>
      <paper-icon-button id="filter_button_2_2" src="/icns/_2_2_science_and_technology.svg" on-tap="handleFilter2_2"></paper-icon-button>
      <paper-icon-button id="filter_button_2_3" src="/icns/_2_3_business.svg" on-tap="handleFilter2_3"></paper-icon-button>
      <paper-icon-button id="filter_button_2_4" src="/icns/_2_4_research.svg" on-tap="handleFilter2_4"></paper-icon-button>
      <paper-icon-button id="filter_button_2_5" src="/icns/_2_5_multidisciplinarity.svg" on-tap="handleFilter2_5"></paper-icon-button>
      <paper-icon-button id="filter_button_3_1" src="/icns/_3_1_entrepreneurship.svg" on-tap="handleFilter3_1"></paper-icon-button>
      <paper-icon-button id="filter_button_3_2" src="/icns/_3_2_corporate_collaboration.svg" on-tap="handleFilter3_2"></paper-icon-button>
      <paper-icon-button id="filter_button_3_3" src="/icns/_3_3_academic_collaboration.svg" on-tap="handleFilter3_3"></paper-icon-button>
      <paper-icon-button id="filter_button_4_1" src="/icns/_4_1_global_event.svg" on-tap="handleFilter4_1"></paper-icon-button>
      <paper-icon-button id="filter_button_4_2" src="/icns/_4_2_regional_event.svg" on-tap="handleFilter4_2"></paper-icon-button>
    </paper-toast>

    <!--    </parallax-container> -->

    <!-- Initial call to get Era data -->
    <iron-ajax
      id="requestEras"
      url=""
      handle-as="json"
      on-response="handleResponseEras">
    </iron-ajax>

  </template>

  <script>
    Polymer({
      is: 'gc-app',

      behaviors: [
        Polymer.IronResizableBehavior
      ],

      properties: {
        /**
        * Domain for API calls.
        * @attribute domain
        * @type string
        * @default https://deepamehta.aalto.fi
        */
        domain: {
          type: String,
          //value: 'http://localhost:8080'
          value: 'https://deepamehta.aalto.fi'
        },
        /**
        * Language setting fi=finnish en=english NB USE LOCAL STORAGE INSTEAD
        * @attribute language
        * @type sting
        * @default fi
        */
        language: {
          type: String,
          value: 'fi'
        },
        /**
        * Local storage
        * @attribute storage
        * @type object
        */
        storage: {
          type: Object
        },
        /**
        * API version string. v1, v2, etc.
        * @attribute version
        * @type sting
        * @default v2
        */
        version: {
          type: String,
          value: 'v2'
        },
        storageLoaded: {
          type: Boolean,
          value: false
        },
        dataLoaded: {
          type: Boolean,
          value: false
        },
        itemCount: {
          type: Number,
          value: 0
        },
        filterChanged: {
          type: Boolean,
          value: false
        },
        filters: {
          type: Array,
          value: [true,true,true,true,true,true,true,true,true,true,true,true,true,true]
        },
        filterNames: {
          type: Array,
          value: ["1_1","1_2","1_3","1_4","2_1","2_2","2_3","2_4","2_5","3_1","3_2","3_3","4_1","4_2"]
        },
        eventTypes: {
          type: Array,
          value: ["_1_1_admin","_1_2_campus","_1_3_students","_1_4_teaching","_2_1_art_and_design","_2_2_science_and_technology","_2_3_business","_2_4_research","_2_5_multidisciplinarity","_3_1_entrepreneurship","_3_2_corporate_collaboration","_3_3_academic_collaboration","_4_1_global_event","_4_2_regional_event"]
        },
        eventColours: {
          type: Array,
          value: ["#007DC8","#007DC8","#007DC8","#007DC8","#BA269A","#BA269A","#BA269A","#BA269A","#BA269A","#FF9A00","#FF9A00","#FF9A00","#6BB100","#6BB100"]
        }
      },

      listeners: {
        'iron-resize': '_onIronResize'
      },

      // When ready call API to get video of the month Id
      ready: function(){
        this.$.requestVideoOfTheMonth.generateRequest();
      },
      attached: function() {
        this.async(this.notifyResize, 1);
      },
      // Resize listeners
      _onIronResize: function() {
        var w = this.offsetWidth;
        //console.log("resized : width = " + w);
        if (this.dataLoaded) {
          if (w < 900) {
            this.$.toastFilters.close();
          } else {
            this.$.toastFilters.open();
          }
        }
      },
      // Initialise local strage with default lang (fi)
      initializeDefaultStorage: function() {
        //console.log("storage Init")
        this.storage = {
          lang: "fi",
          label: "English"
        }
        // Trigger load data manually after init on first visit
        this.handleLocalstorageLoadEvent();
      },
      // Once we have local settings we know the language, so load data
      handleLocalstorageLoadEvent: function(){
        //console.log("local storage : @ storage load " + this.storage.lang);
        this.language = this.storage.lang;
        this.storageLoaded = true;
        // request Eras
        this.$.requestEras.url = this.domain + "/gamechangers/" + this.version + "/" + this.language + "/eras";
        this.$.requestEras.generateRequest();
      },
      // Toggle language between FI and EN then reload
      changeLanguage: function() {
        if (this.storage.lang == "fi") {
          this.set('storage.lang', "en");
          this.set('storage.label', "Suomeksi");
          this.language = "en";
        } else {
          this.set('storage.lang', "fi");
          this.set('storage.label', "English");
          this.language = "fi";
        }
        location.reload(false);
      },
      // Called everytime era dom is changed
      eraDOM: function(event) {
        // Once the dom changes have stopped, stop spinner, show toast, etc.
        this.debounce('doSomething', function () {
          //console.log('Debounce...');
          this.dataLoaded = true;
          this.$.spinner.active = false;
          this.$.toastFilters.open();

          if (this.queryParams.event) {
            //console.log('Deep link...');
            var deep = "#eventDiv" + this.queryParams.event;
            this.$$(deep).scrollIntoView();
            var collapse = "#collapse" + this.queryParams.event;
            this.$$(collapse).toggle();
            var commentDiv = '#comment' + this.queryParams.event;
            var associationsDiv = '#associations' + this.queryParams.event;
            this.$$(commentDiv).style.display='flex'
            this.$$(associationsDiv).style.display='flex'
          }
        }, 300);
      },
      // UI Localisation functions
      languageFinnish: function() {
        return (this.language == "fi");
      },
      localisedTitle: function() {
        return (this.language == "fi") ? "title_FIN.png" : "title.png";
      },
      localisedTitleMobile: function() {
        return (this.language == "fi") ? "title_FIN_mobile.png" : "title_mobile.png";
      },
      localisedH1: function() {
        return (this.language == "fi") ? "Tervetuloa!" : "Welcome!";
      },
      localisedP1: function() {
        return (this.language == "fi") ? "Aalto-yliopiston aikajana kertoo visuaalisin keinoin tarinoita Muutoksentekijöistä – henkilöistä, tapahtumista tai innovaatioista – Aallon tai sen edeltäjien piirissä. Muutoksentekijöistä, joilla on ollut suuri vaikutus suomalaisen yhteiskunnan kehitykseen." : "The Aalto timeline tells a story visualising and describing Game Changers, which can be events and innovations, derived from Aalto University and its predecessors. Or people, who have had a great impact on Aalto and the Finnish society.";
      },
      localisedP2: function() {
        return (this.language == "fi") ? "Aikajana kehittyy vähitellen, joten pyydämme myös sinun panostasi Aallon tarinaan alkaen vuodesta 1849. Kerro visiosi Aallon tulevaisuudesta. Jos aikajanalta puuttuu jotain, klikkaa ehdota-nappia alla ja kerro meille. Voit myös lähettää anekdootin suoraan liittyen aikajanalla oleviin tapahtumiin. Odotamme panostasi, suurkiitos siitä etukäteen!" : "The timeline is gradually evolving, therefore, we reach out to you to give your contribution in telling the Aalto story from 1849 to date, and into the future. Share your ideas with us! If something is missing from the timeline, tell us about it by clicking on 'Propose' and send your suggestion. You can also suggest an anecdote related to an event already on the timeline. We look forward to your comments. Many thanks for your input!";
      },
      localisedVideoH1: function() {
        return (this.language == "fi") ? "Uusin Muutoksentekijät -video" : "Latest Game Changers video";
      },
      localisedPropose: function() {
        return (this.language == "fi") ? "Ehdota" : "Propose";
      },
      localisedComment: function() {
        return (this.language == "fi") ? "Kommentoi" : "Comment";
      },
      localisedShare: function() {
        return (this.language == "fi") ? "Jaa" : "Share";
      },
      localisedCommentDescription: function() {
        return (this.language == "fi") ? "Onko sinulla tähän tapahtumaan liittyvä anekdootti? Lähetä se ja sisältötiimimme julkaisee niistä osan. Käytä oikeaa nimeäsi ja toimivaa sähköpostiosoitetta niin voimme olla tarvittaessa yhteydessä sinuun." : "Do you have an anekdote relating to this event? Send it to us and our editorial team will publish some of them. Use your real name for signing it and working email we can reach you from should there be questions.";
      },
      localisedCommentSucceeded: function() {
        return (this.language == "fi") ? "Kiitos kommentistasi! Sisältötyöryhmä käy läpi kaikki kommentit ja julkaisee niistä osan. Otamme yhteyttä jos lisäkysymyksiä nousee esiin." : "Thank you for your comment. The editorial team will check all comments and publish some of them. We will contact you if further questions.";
      },
      localisedCommentFailed: function() {
        return (this.language == "fi") ? "Lähetys epäonnistui" : "Submit failed";
      },
      localisedProposeDescription: function() {
        return (this.language == "fi") ? "Puuttuko aikajanalta jotain? Lähetä ehdotus sisältötiimillemme. Olemme kiinnostuneita muutokseen johtaneista tapahtumista Aalto-yliopiston ja sitä edeltäneiden koulujen historiasta." : "Is something missing from the timeline? Send a suggestion to our editorial team. We are interested in Game Changers events from the history of Aalto University and its predecessing schools. You can also send us visions of Aalto future.";
      },
      localisedProposeSucceeded: function() {
        return (this.language == "fi") ? "Kiitos ehdotuksestasi! Sisältötyöryhmä valitsee kaikista ehdotuksista muutoksentekijä tapahtumia. Otamme yhteyttä jos lisäkysymyksiä nousee esiin." : "Thank you for your suggestion. The timeline editorial team will select new Game Changers events from the suggestions. We will contact you if there are any questions on the matter.";
      },
      localisedProposeFailed: function() {
        return (this.language == "fi") ? "Lähetys epäonnistui" : "Submit failed";
      },
      localisedName: function() {
        return (this.language == "fi") ? "Nimi" : "Name";
      },
      localisedEmail: function() {
        return (this.language == "fi") ? "Email" : "Email";
      },
      localisedCancel: function() {
        return (this.language == "fi") ? "Peruuta" : "Cancel";
      },
      localisedSubmit: function() {
        return (this.language == "fi") ? "Lähetä" : "Submit";
      },
      localisedShareDescription: function() {
        return (this.language == "fi") ? "Jaa linkki alta haluamaasi some-kanavaan" : "Share link from below to a channel of you choice";
      },
      // Function to check if an array is empty
      arrayEmpty: function(array) {
        return array.length == 0;
      },
      arrayItem: function(arry, index, path) {
        //console.log("background url : " + this.get(path, arry.base[index]));
        return this.get(path, arry.base[index]);
      },
      // Format the image array for image-slider, just urls, no captions
      formatImageArray: function(array) {
        var imageArray = [];
        for (var i = 0; i < array.length; i++) {
          imageArray[i] = array[i].url;
        }
        return imageArray;
      },
      // Format the captions array for image-slider, just captions, no urls
      formatCaptionArray: function(array) {
        var captionArray = [];
        for (var i = 0; i < array.length; i++) {
          captionArray[i] = array[i].caption;
        }
        return captionArray;
      },
      // Strip HTML tags, specifically img tags from notes
      justText: function(htmlContent) {
        // more efficient to do this in the backend?
        var r = htmlContent.replace(/<img[^>]*>/g,"");
        return r;
      },
      stripURL: function(url){
        //console.log ("striping : " + url);
        url = url.replace(/%2F/gi, "/");
        //console.log ("stripped : " + url);
        return url;
      },
      getCommentURL: function() {
        //return "http://localhost:8080/gamechangers/v1/comment";
        return this.domain + "/gamechangers/v1/comment";
      },
      getProposeURL: function() {
        //return "http://localhost:8080/gamechangers/v1/propose";
        return this.domain + "/gamechangers/v1/proposal";
      },
      // Handles data being returned from the API call to get video of the month
      handleResponseVideoOfTheMonth: function (data) {
          //console.log("Video of the month vime ID = " + data.detail.response);
          this.videoOfTheMonth = data.detail.response;
      },
      // Handles data being returned from the API call to get eras
      handleResponseEras: function (data) {
          //console.log("number of eras = " + data.detail.response.length);
          this.eras = data.detail.response;
      },
      // Event sorting function
      sortEvents: function (a, b) {
          return parseFloat(b.from) - parseFloat(a.from);
      },
      // Era sorting function
      sortEras: function (a, b) {
          return parseFloat(b.from) - parseFloat(a.from);
      },
      // return whether the filter for the supplied event type is on or off
      filtered: function (type, updated) {
        var i = this.eventTypes.indexOf(type);
        return this.filters[i] ? true : false;
      },
      // Toggle event cards visibility and filter icon opacity based on event type
      handleFilter1_1: function(e) {
        this.toggleFilter(0);
      },
      handleFilter1_2: function(e) {
        this.toggleFilter(1);
      },
      handleFilter1_3: function(e) {
        this.toggleFilter(2);
      },
      handleFilter1_4: function(e) {
        this.toggleFilter(3);
      },
      handleFilter2_1: function(e) {
        this.toggleFilter(4);
      },
      handleFilter2_2: function(e) {
        this.toggleFilter(5);
      },
      handleFilter2_3: function(e) {
        this.toggleFilter(6);
      },
      handleFilter2_4: function(e) {
        this.toggleFilter(7);
      },
      handleFilter2_5: function(e) {
        this.toggleFilter(8);
      },
      handleFilter3_1: function(e) {
        this.toggleFilter(9);
      },
      handleFilter3_2: function(e) {
        this.toggleFilter(10);
      },
      handleFilter3_3: function(e) {
        this.toggleFilter(11);
      },
      handleFilter4_1: function(e) {
        this.toggleFilter(12);
      },
      handleFilter4_2: function(e) {
        this.toggleFilter(13);
      },
      toggleFilter: function(filter) {
        var selector = "#filter_button_" + this.filterNames[filter];
        var op = this.filters[filter] ? "0.3" : "1.0";
        this.filters[filter] = !this.filters[filter];
        this.$$(selector).style.opacity = op;
        this.filterChanged = !this.filterChanged;
      },
      // Toggle event card collapse on tap based on ID
      handleEventCollapse: function(event, detail, sender) {
        var id = event.model.eventItem.id;
        var selector = '#collapse' + id;
        var commentDiv = '#comment' + id;
        var associationsDiv = '#associations' + id;

        if (this.$$(selector).opened) {
          try {
            this.$$(commentDiv).style.display='none'
          } catch(e) {
            // commentDiv not create/active
            //console.log("caught collapse comment div excpetion");
          }

          this.$$(associationsDiv).style.display='none'
        } else {
          try {
            this.$$(commentDiv).style.display='flex'
          } catch(e) {
            // commentDiv not create/active
            //console.log("caught collapse comment div excpetion");
          }
          this.$$(associationsDiv).style.display='flex'
        }
        this.$$(selector).toggle();
      },
      // Toggle association card collapse on tap based on ID
      handleAssociationCollapse: function(event, detail, sender) {
        //console.log("association id" + event.model.association.id);
        var id = event.model.eventItem.id;
        var associationId = event.model.association.id;
        var card = '#associationCollapse' + id + associationId;
        this.$$(card).toggle();
      },
      handleEventComment: function(event, detail, sender) {
        //console.log("comment tap event");
        var id = event.model.eventItem.id;
        //console.log("open comment dialog for event : " + id);
        var dialog = '#commentDialog' + id;
        this.$$(dialog).open();
      },
      // Copy link to clipboard and open share dialog
      handleEventShare: function(event, detail, sender) {
        //console.log("share tap event");
        var id = event.model.eventItem.id;
        //console.log("open share dialog for event : " + id);
        var dialog = '#shareDialog' + id;
        this.$$(dialog).open();
/*
        //var link = "https://gamechangers.aalto.fi/?event=" + id;
        //document.execCommand('copy',false,link);
        var sharetext = '#shareText' + id;
        //this.$$(sharetext).select();
        document.getElementById('sharetext').select();

        try {
          // Now that we've selected the anchor text, execute the copy command
          var successful = document.execCommand('copy');
          var msg = successful ? 'successful' : 'unsuccessful';
          console.log('Copy command was ' + msg);
        } catch(err) {
          console.log('unable to copy');
        }
*/
      },
      handleEventPropose: function(event, detail, sender) {
        this.$$("#proposeDialog").open();
      },
      openCreditsDialog: function() {
        this.$$("#creditsDialog").open();
      },
      // Open carousel dialog when full screen button is tapped
      handleEventCarousel: function(event, detail, sender) {
        //console.log("full screen tap event");
        var id = event.model.eventItem.id;
        //console.log("open image carousel dialog for event : " + id);
        var dialog = '#carouselDialog' + id;
        this.$$(dialog).open();
      },
      // Handle response from API after comment, display message close dialog on success.
      handleResponseComment: function (event) {
        var id = event.model.eventItem.id;
        var dialog = '#commentDialog' + id;
        this.$$(dialog).close();
        alert (this.localisedCommentSucceeded());
      },
      // Handle response from API after comment, display message close dialog on success.
      handleResponsePropose: function (event) {
        //console.log("propose response : " + JSON.stringify(data.detail.response));
        //console.log("propose response id " + data.detail.response.id);
        this.$$("#proposeDialog").close();
        alert (this.localisedProposeSucceeded());
      },
      // function used to submit comment form
      submitComment: function(event) {
        var form = event.target.parentElement;
        // work around to change method to PUT before submitting
        form.addEventListener('iron-form-presubmit', function() {
          //console.log("pre-submit form function called");
          this.request.method = 'PUT';
          this.request.url =  'https://deepamehta.aalto.fi/gamechangers/v1/comment';
          this.request.handleAs = 'json';
          //console.log(this.serialize());
        });
        form.addEventListener('iron-form-error', function(event) {
          //console.log("comment form error response");
          alert (this.localisedCommentFailed());
        });
        //console.log("submit form function called : ") ;
        form.submit();
      },
      // function used to submit comment form
      submitProposal: function(event) {
        var form = event.target.parentElement;
        // work around to change method to PUT before submitting
        form.addEventListener('iron-form-presubmit', function() {
          //console.log("pre-submit form function called");
          this.request.method = 'PUT';
          this.request.url =  'https://deepamehta.aalto.fi/gamechangers/v1/proposal';
          this.request.handleAs = 'json';
          //console.log(this.serialize());
        });
        form.addEventListener('iron-form-error', function(event) {
          //console.log("comment form error response");
          alert (this.localisedProposeFailed());
        });
        //console.log("submit form function called : ") ;
        form.submit();
      },
      // return the colour based on suplied event type
      eventColour: function (type) {
        var c;
        var i = this.eventTypes.indexOf(type);
        if (i == -1) {
          c = "#9B9B9B";
        } else {
          c = this.eventColours[i];
        }
        return c;
      },
      // return year string of timestamp supplied
      eventYear: function (timestamp) {
        var d = new Date(timestamp);
        return d.getFullYear();
      },
      // Return true if the year end in 0, i.e. first in a decade
      yearIsFirstInDecade: function (timestamp) {
        var d = new Date(timestamp);
        var y = d.getFullYear();
        var s = y.toString();
        var l = s.substr(s.length - 1);
        return l == "0";
      }
    });
  </script>

</dom-module>
